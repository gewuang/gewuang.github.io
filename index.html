<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







  

<link href="https://cdnjs.cat.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="当你觉得晚的时候，恰恰是最早的时候">
<meta property="og:type" content="website">
<meta property="og:title" content="Ramon&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Ramon&#39;s Blog">
<meta property="og:description" content="当你觉得晚的时候，恰恰是最早的时候">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ramon&#39;s Blog">
<meta name="twitter:description" content="当你觉得晚的时候，恰恰是最早的时候">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Ramon's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ramon's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录平时工作学习中的知识</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/nodejs-module-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/nodejs-module-2/" itemprop="url">Node模块详解（二）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T14:22:06+08:00">
                2020-03-07
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-03-15T23:55:32+08:00">
                2020-03-15
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node-js/" itemprop="url" rel="index">
                    <span itemprop="name">Node.js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.1k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  8 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>上篇文章介绍了模块机制中的文件模块（<a href="https://gewuang.cn/2020/03/01/nodejs-module-1/" target="_blank" rel="noopener">直通链接</a>），本篇文章继续接着介绍node模块机制中剩余的模块类型：</p>
<ul>
<li>核心模块</li>
<li>扩展模块</li>
</ul>
<p><em>注：本文是学习《深入浅出Node.js》一书的学习笔记，所以参考源码与书上版本一致。（版本：v0.10.13-release）</em></p>
<h1 id="核心模块"><a href="#核心模块" class="headerlink" title="核心模块"></a>核心模块</h1><h2 id="什么是核心模块"><a href="#什么是核心模块" class="headerlink" title="什么是核心模块"></a>什么是核心模块</h2><p>区别于文件模块等第三方导入模块，核心模块就是<strong>直接包含在node源码中，为用户提供服务的模块</strong>。</p>
<p>当然这些模块也需要导入的，想了解都有哪些模块，直接进入官网，找到Docs文档，里面介绍的模块都是核心模块（链接：<a href="https://nodejs.org/dist/latest-v12.x/docs/api/" target="_blank" rel="noopener">核心模块介绍</a>）。</p>
<p>简单列举几个比较常用的核心模块：</p>
<ul>
<li>fs：提供对文件的读写等操作</li>
<li>http：提供了搭建本地服务器的API</li>
<li>path：提供文件路径操作的API</li>
<li>os：操作系统相关信息的API</li>
<li>url：提供了操作URL信息的API</li>
</ul>
<h2 id="核心模块导入流程"><a href="#核心模块导入流程" class="headerlink" title="核心模块导入流程"></a>核心模块导入流程</h2><p>核心模块的使用官网已经非常详细了，我也没什么好介绍的，今天的重点是核心模块在Node源码中是以什么形式存在的，以及核心模块的导入流程。</p>
<h3 id="Node源码中的核心模块"><a href="#Node源码中的核心模块" class="headerlink" title="Node源码中的核心模块"></a>Node源码中的核心模块</h3><p>核心模块一般分为两部分：</p>
<ul>
<li>C++编写的内建模块（核心实现）</li>
<li>JavaScript编写的封装模块</li>
</ul>
<p>其中C++部分的代码存放在<code>src/</code>目录下，而JavaScript的代码存放在<code>lib/</code>下。</p>
<p>一般我们调用的都是JS编写的封装模块，在对Node源码不是特别了解的情况下，不建议直接调用C++编写的内建模块（调用方法也就不告诉你了）。 </p>
<h3 id="导入流程"><a href="#导入流程" class="headerlink" title="导入流程"></a>导入流程</h3><p>导入流程主要分为如下几个步骤:</p>
<ol>
<li>js代码转存</li>
<li>运行时从内存中取出内容</li>
<li>编译执行</li>
<li>对象缓存和返回</li>
</ol>
<p>看不懂没关系，下面详细介绍。</p>
<h4 id="js代码转存"><a href="#js代码转存" class="headerlink" title="js代码转存"></a>js代码转存</h4><p>node编译过程中，并不会对js部分的代码进行编译操作，而是调用<code>tools/js2c.py</code>工具将js代码转换成C++中的字符串数组，存放在<code>node_natives.h</code>文件中，手动执行后的情况如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200315204045.png" alt="js2c"></p>
<p>看代码就知道，这一步其实做了个很简单的事情，把js文件内容<code>console.log(&quot;hello&quot;);</code>变成ASCII码放在<code>$filename_native</code>数组中，这样node源码编译时，js文件的内容也就以字符串的形式编译进了可执行文件中。</p>
<h4 id="取出文件"><a href="#取出文件" class="headerlink" title="取出文件"></a>取出文件</h4><p>知道内容被存到<code>node_natives.h</code>文件中，那么取出的代码就很好找了，首先找到调用文件的地方，运气很好，只有一个文件<code>node_javascript.cc</code>，而且确实是获取js文件的代码，函数很简单，直接贴源码了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DefineJavaScript</span><span class="params">(v8::Handle&lt;v8::Object&gt; target)</span> </span>&#123;</span><br><span class="line">  HandleScope scope;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; natives[i].name; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (natives[i].source != node_native) &#123;</span><br><span class="line">      Local&lt;String&gt; name = String::New(natives[i].name);</span><br><span class="line">      Handle&lt;String&gt; source = BUILTIN_ASCII_ARRAY(natives[i].source, natives[i].source_len);</span><br><span class="line">      target-&gt;Set(name, source);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一共几行代码，功能就是把想要的js文件内容取出，这里有个条件，是除了<code>node_native</code>模块，这里其实就是<code>node.js</code>文件，这个文件在<code>src/</code>下，这个文件很重要，这里先不说明，我们继续往下走。</p>
<p>以前版本的代码就是简单，这里我们查使用函数<code>DefineJavaScript()</code>的地方，发现也只有一个地方，就是我们的<code>node.cc</code>文件（题外话，这个文件就是定义着我们的全局变量<code>process</code>的地方），而使用的函数为<code>Binding()</code>，以下为源码内容：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Handle&lt;Value&gt; Binding(<span class="keyword">const</span> Arguments&amp; args) &#123;</span><br><span class="line">  Local&lt;String&gt; <span class="keyword">module</span> = args[<span class="number">0</span>]-&gt;ToString();</span><br><span class="line">  String::<span class="function">Utf8Value <span class="title">module_v</span><span class="params">(<span class="keyword">module</span>)</span></span>;</span><br><span class="line">	...</span><br><span class="line">  <span class="keyword">if</span> ((modp = get_builtin_module(*module_v)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(*module_v, <span class="string">"constants"</span>)) &#123;</span><br><span class="line">		...</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(*module_v, <span class="string">"natives"</span>)) &#123;</span><br><span class="line">    <span class="comment">// 重点关注内容</span></span><br><span class="line">    exports = Object::New();</span><br><span class="line">    DefineJavaScript(exports);</span><br><span class="line">    binding_cache-&gt;Set(<span class="keyword">module</span>, exports);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ThrowException(Exception::Error(String::New(<span class="string">"No such module"</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> scope.Close(exports);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>去掉无关的代码，留下我们的重要关注内容，从这部分代码可以得出，调用<code>process.Binding(&#39;natives&#39;)</code>就可以取出内存中的js代码，而这个引用就在我们刚刚谈到的<code>node.js</code>中，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NativeModule._source = process.binding('natives');</span><br></pre></td></tr></table></figure>

<p>重点出来了，之前我们讲过，文件模块操作的对象为<code>Module</code>，那么我们核心模块的对象就是<code>NativeModule</code>，</p>
<h4 id="编译-amp-缓存"><a href="#编译-amp-缓存" class="headerlink" title="编译&amp;缓存"></a>编译&amp;缓存</h4><p>当我们对一个核心模块引用时，实际上就是运行了下列代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">NativeModule.require = <span class="function"><span class="keyword">function</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id == <span class="string">'native_module'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NativeModule;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> cached = NativeModule.getCached(id);</span><br><span class="line">    <span class="keyword">if</span> (cached) &#123;</span><br><span class="line">        <span class="keyword">return</span> cached.exports;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!NativeModule.exists(id)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'No such native module '</span> + id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    process.moduleLoadList.push(<span class="string">'NativeModule '</span> + id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> nativeModule = <span class="keyword">new</span> NativeModule(id);</span><br><span class="line"></span><br><span class="line">    nativeModule.cache();</span><br><span class="line">    nativeModule.compile();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nativeModule.exports;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 从缓存中取出</span></span><br><span class="line">NativeModule.getCached = <span class="function"><span class="keyword">function</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> NativeModule._cache[id];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 判断是否存在</span></span><br><span class="line">NativeModule.exists = <span class="function"><span class="keyword">function</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> NativeModule._source.hasOwnProperty(id);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从内存中得到js代码</span></span><br><span class="line">NativeModule.getSource = <span class="function"><span class="keyword">function</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> NativeModule._source[id];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 封装</span></span><br><span class="line">NativeModule.wrap = <span class="function"><span class="keyword">function</span>(<span class="params">script</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> NativeModule.wrapper[<span class="number">0</span>] + script + NativeModule.wrapper[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">NativeModule.wrapper = [</span><br><span class="line">    <span class="string">'(function (exports, require, module, __filename, __dirname) &#123; '</span>,</span><br><span class="line">            <span class="string">'\n&#125;);'</span></span><br><span class="line">];</span><br><span class="line"><span class="comment">// 编译</span></span><br><span class="line">NativeModule.prototype.compile = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> source = NativeModule.getSource(<span class="keyword">this</span>.id);</span><br><span class="line">    source = NativeModule.wrap(source);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fn = runInThisContext(source, <span class="keyword">this</span>.filename, <span class="literal">true</span>);</span><br><span class="line">    fn(<span class="keyword">this</span>.exports, NativeModule.require, <span class="keyword">this</span>, <span class="keyword">this</span>.filename);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.loaded = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 保存到缓存中</span></span><br><span class="line">NativeModule.prototype.cache = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    NativeModule._cache[<span class="keyword">this</span>.id] = <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>一下子放这么多代码实在是不应该，但是这部分代码简单而道出了核心模块导入的本质，实在不忍心割掉一点点，每个函数都对功能添加了注释，请务必仔细研读。</p>
<p>另外谈一点，核心模块的js代码因为是从内存中取出的，相比于从磁盘取出的文件模块加载速度肯定要快上很多。</p>
<p>核心模块至此就结束了，流程简单来说就是：编译node时将核心js代码变成c++中的字符串数组，引用的时候从内存中取出并进行编译，然后缓存放到<code>NativeModule._cache</code>中并返回编译后的对象，如果你看过文件模块的介绍，相比并不难掌握。</p>
<h1 id="扩展模块"><a href="#扩展模块" class="headerlink" title="扩展模块"></a>扩展模块</h1><p>终于讲完了核心模块，希望你已经掌握，下面来讲一种特殊的文件模块，扩展模块。</p>
<h2 id="什么是扩展模块"><a href="#什么是扩展模块" class="headerlink" title="什么是扩展模块"></a>什么是扩展模块</h2><p>亘古不变，我们先来说下是什么。</p>
<p><strong>扩展模块</strong>是用C/C++代码预编译后得到的<code>.node</code>文件，代码中调用<code>process.dlopen()</code>进行加载执行。显然这种方式性能要高于js编写的文件模块，而且在需要大量的位运算操作的场景中，C/C++的性能要优于JS。</p>
<blockquote>
<p>JavaScript的位运算参照Java的位运算实现，但是Java位运算是在<code>int</code>型数字的基础上进行的，而JavaScript中只有<code>double</code>型的数据类型，在进行位运算的过程中，需要将<code>double</code>型转换为<code>int</code>型，然后再进行。所以，在JavaScript层面上做位运算的效率不高。（节选自书中）</p>
</blockquote>
<p>这里你可能要说，那大家都去些扩展模块算了。世界上没有完美的东西，扩展模块也有他的缺点，当然，C/C++语言的学习和开发难度肯定是第一点，不然脚本语言也不会盛行于世，其次就是不再支持跨平台，对于*nix和windows平台的差异如下：</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200315224621.png" alt="区别" style="zoom:30%;">

<p>这里也为我们展现了扩展模块的编译和导入流程。</p>
<p>所以在需要跨平台的应用上，应该对扩展模块的使用要小心，</p>
<h2 id="实现一个自己的扩展模块"><a href="#实现一个自己的扩展模块" class="headerlink" title="实现一个自己的扩展模块"></a>实现一个自己的扩展模块</h2><p>是的，这里应该有一个实现，不过这部分我并没有掌握清楚，书中的例子因为版本古老，编译失败了，所以这里也就不展示了，给自己留个坑，也希望感兴趣的小伙伴可以研究实现一个自己的扩展模块，加油，你们是最胖的！！！</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>模块深入学习打开了我对node源码解读的开端，尽管代码是老的版本，但依旧能从中学到很多，这一系列文章是我读《深入浅出Node.js》一书的学习笔记，也希望自己能够成功读完，并将学习后的知识分享给大家。</p>

          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/01/nodejs-module-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/01/nodejs-module-1/" itemprop="url">Node模块详解（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-01T21:52:59+08:00">
                2020-03-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-03-04T15:15:37+08:00">
                2020-03-04
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node-js/" itemprop="url" rel="index">
                    <span itemprop="name">Node.js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.5k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>本文是阅读《深入浅出Node.js》后对自己所学和理解的内容进行整理后完成的，结合Node源码为读者解读模块这一基础而又非常重要的一个机制是怎么实现和运转的。</p>
<p>此文为Node模块详解系列第一篇，主要介绍模块以及实现。</p>
<h1 id="CommonJS规范"><a href="#CommonJS规范" class="headerlink" title="CommonJS规范"></a>CommonJS规范</h1><p>说到模块就先介绍下CommonJS规范，因为模块是它提出的，而Node也对规范有了很好的实现（尽管Node的npm管理器作者在13年宣称废弃它）。</p>
<p>引用维基百科的介绍：</p>
<blockquote>
<p><strong>CommonJS</strong>是一个项目，其目标是为<a href="https://zh.wikipedia.org/wiki/JavaScript" target="_blank" rel="noopener">JavaScript</a>在<a href="https://zh.wikipedia.org/wiki/网页浏览器" target="_blank" rel="noopener">网页浏览器</a>之外创建<a href="https://zh.wikipedia.org/wiki/子程序" target="_blank" rel="noopener">模块</a>约定。</p>
</blockquote>
<p>说白话，就是希望JS摆脱前端束缚，能够在任何地方使用，比如：</p>
<ul>
<li>服务端</li>
<li>命令行工具</li>
<li>桌面应用程序</li>
<li>混合应用（Titanium和Adobe AIR等形式的应用（我也没懂zzz~））</li>
</ul>
<p>详细了解去看<a href="http://www.commonjs.org/" target="_blank" rel="noopener">CommonJS官网</a>，这里不做详细介绍，我们重点关注模块。</p>
<h2 id="CommonJS的模块规范"><a href="#CommonJS的模块规范" class="headerlink" title="CommonJS的模块规范"></a>CommonJS的模块规范</h2><p>CommonJS对模块的定义为模块引用、模块定义和模块标识3个部分。</p>
<ol>
<li><p>模块引用</p>
<p>通过require()方法导入一个模块的API到当前上下文中。</p>
<p>示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>模块定义</p>
<p>对应引入的功能，上下文提供了exports对象。在模块中，存在一个module对象，它代表模块自身，exports是module的属性，用于导出当前模块的方法或者变量，并且它是唯一导出的出口，module信息如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200302004835.png" alt="module信息"></p>
<p>在Node中，一个文件就是一个模块，将值传给exports对象即可导出。</p>
</li>
<li><p>模块标识</p>
<p>模块标识其实就是传递给<code>require()</code>方法的参数，即导入模块的name。</p>
</li>
</ol>
<p>模块的定义十分简单，接口也十分简洁。它的意义在于将类聚的方法和变量等限定在私有的作用域中，同时支持引入和导出功能以顺畅地连接上下游依赖。</p>
<h1 id="Node模块实现"><a href="#Node模块实现" class="headerlink" title="Node模块实现"></a>Node模块实现</h1><p>Node参考CommonJS规范进行模块设计，同时也增加了一些自身的特性，本文我们主要研究Node内部如何实现模块机制。</p>
<p>在Node中，模块主要分为两类</p>
<ul>
<li>核心模块：Node提供的模块（Node启动时直接加载）</li>
<li>文件模块：用户编写的模块（运行时动态加载）</li>
</ul>
<p>本文主要主要研究的是文件模块的加载编译流程，主要分为三个步骤：</p>
<ol>
<li>路径分析</li>
<li>文件定位</li>
<li>编译执行</li>
</ol>
<h2 id="路径分析和文件定位"><a href="#路径分析和文件定位" class="headerlink" title="路径分析和文件定位"></a>路径分析和文件定位</h2><p>顾名思义：找到要导入的模块。因为模块标识符情况比较多，所以在这里讲一下。标识符主要分为以下几类：</p>
<ul>
<li>核心模块：如http、fs等直接写</li>
<li>相对路径文件模块：<code>.</code>或者<code>..</code>开头的</li>
<li>绝对路径模块：以<code>/</code>开头的</li>
<li>自定义模块：在node_modules目录中的模块</li>
</ul>
<p>核心模块直接编译在node内部，导入最快，带路径的则要进行解析，解析流程如下：</p>
<blockquote>
<p>在分析标识符的过程中，<code>require()</code>通过分析文件扩展名之后，可能没有查找到对应文件，但却得到一个目录，这在引入自定义模块和逐个模块路径进行查找时经常会出现，此时Node会将目录当做一个包来处理。</p>
<p>在这个过程中，Node对CommonJS包规范进行了一定程度的支持。首先，Node在当前目录下查找package.json（CommonJS包规范定义的包描述文件），通过<code>JSON.parse()</code>解析出包描述对象，从中取出<code>main</code>属性指定的文件名进行定位。如果文件名缺少扩展名，将会进入扩展名分析的步骤。</p>
<p>而如果<code>main</code>属性指定的文件名错误，或者压根没有package.json文件，Node会将<code>index</code>当做默认文件名，然后依次查找index.js、index.node、index.json。</p>
<p>如果在目录分析的过程中没有定位成功任何文件，则自定义模块进入下一个模块路径进行查找。如果模块路径数组都被遍历完毕，依然没有查找到目标文件，则会抛出查找失败的异常。</p>
</blockquote>
<p>内容引用书里的，本来想画个流程图，结果发现还不如直接看原文明白，毕竟这里不是我们的重点关注，也就不细讲了。</p>
<p>前面讲了这么多，终于讲到我们今天的重点：模块编译。</p>
<h2 id="模块编译"><a href="#模块编译" class="headerlink" title="模块编译"></a>模块编译</h2><p>上述步骤后，我们已经定位到文件，进入后续编译和执行环节。</p>
<p><em>注：本章主要结合源码进行分析，有兴趣可以下载<a href="https://github.com/nodejs/node" target="_blank" rel="noopener">源码</a>学习（版本：v0.10.13-release）。</em></p>
<p>之前讲到过，一个文件就是一个模块，而一个（文件）模块也是一个对象，定义如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Module</span>(<span class="params">id, parent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.id = id;</span><br><span class="line">  <span class="keyword">this</span>.exports = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.parent = parent;</span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; parent.children) &#123;</span><br><span class="line">    parent.children.push(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.filename = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.loaded = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">this</span>.children = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模块的载入以文件类型进行区分，不同的扩展名，载入方式也不同，分为以下四种情况：</p>
<ul>
<li>js文件：通过<code>fs</code>模块同步读取文件后编译执行</li>
<li>node文件：用c/c++编写的扩展文件，通过dlopen()加载编译生成的文件</li>
<li>json文件：通过fs模块读取，使用JSON.parse()解析返回</li>
<li>其他扩展名文件：当做.js文件载入</li>
</ul>
<p>解析扩展名的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype.load = <span class="function"><span class="keyword">function</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  debug(<span class="string">'load '</span> + <span class="built_in">JSON</span>.stringify(filename) +</span><br><span class="line">        <span class="string">' for module '</span> + <span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.id));</span><br><span class="line"></span><br><span class="line">  assert(!<span class="keyword">this</span>.loaded);</span><br><span class="line">  <span class="keyword">this</span>.filename = filename;</span><br><span class="line">  <span class="keyword">this</span>.paths = Module._nodeModulePaths(path.dirname(filename));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> extension = path.extname(filename) || <span class="string">'.js'</span>;</span><br><span class="line">  <span class="keyword">if</span> (!Module._extensions[extension]) extension = <span class="string">'.js'</span>; <span class="comment">// 这里对其他扩展名以js文件对待</span></span><br><span class="line">  Module._extensions[extension](<span class="keyword">this</span>, filename);</span><br><span class="line">  <span class="keyword">this</span>.loaded = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来对这三种文件的载入以及编译进行详细讲解</p>
<h3 id="js文件"><a href="#js文件" class="headerlink" title=".js文件"></a>.js文件</h3><p>.js文件是我们主要关注的重点，它要比其他两种情况多一个<strong>包装</strong>的步骤。</p>
<p>使用过node的朋友都知道，每个模块都有<code>__filename</code>、<code>__dirname</code>这两个变量的存在，并且模块也有自己单独的作用域，不同模块之间参数不会被相互污染，这个其实就是Node在编译前对模块文件进行了封装，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NativeModule.wrap = <span class="function"><span class="keyword">function</span>(<span class="params">script</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> NativeModule.wrapper[<span class="number">0</span>] + script + NativeModule.wrapper[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">NativeModule.wrapper = [</span><br><span class="line">  <span class="string">'(function (exports, require, module, __filename, __dirname) &#123; '</span>,</span><br><span class="line">  <span class="string">'\n&#125;);'</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>非常简单的代码，却实现了每个模块文件之间作用域的隔离，为模块注入了灵魂。</p>
<p>包装之后的代码会通过<code>vm</code>原生模块的<code>runInThisContext()</code>方法执行，返回一个具体的<code>function</code>对象。最后，将当前模块对象的<code>exports</code>属性、<code>require()</code>方法、<code>module</code>（模块对象自身），以及在文件定位中得到的完整文件路径和文件目录作为参数传递给这个<code>function()</code>执行，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Native extension for .js</span></span><br><span class="line">Module._extensions[<span class="string">'.js'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">module, filename</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> content = NativeModule.require(<span class="string">'fs'</span>).readFileSync(filename, <span class="string">'utf8'</span>);</span><br><span class="line">  <span class="built_in">module</span>._compile(stripBOM(content), filename);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns exception if any</span></span><br><span class="line">Module.prototype._compile = <span class="function"><span class="keyword">function</span>(<span class="params">content, filename</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// remove shebang</span></span><br><span class="line">  content = content.replace(<span class="regexp">/^\#\!.*/</span>, <span class="string">''</span>);</span><br><span class="line">	...</span><br><span class="line">  <span class="keyword">if</span> (Module._contextLoad) &#123;</span><br><span class="line">    <span class="comment">// create wrapper function</span></span><br><span class="line">  <span class="keyword">var</span> wrapper = Module.wrap(content);	<span class="comment">//这里进行的包装</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> compiledWrapper = runInThisContext(wrapper, filename, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">if</span> (global.v8debug) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!resolvedArgv) &#123;</span><br><span class="line">      <span class="comment">// we enter the repl if we're not given a filename argument.</span></span><br><span class="line">      <span class="keyword">if</span> (process.argv[<span class="number">1</span>]) &#123;</span><br><span class="line">        resolvedArgv = Module._resolveFilename(process.argv[<span class="number">1</span>], <span class="literal">null</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolvedArgv = <span class="string">'repl'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Set breakpoint on module start</span></span><br><span class="line">    <span class="keyword">if</span> (filename === resolvedArgv) &#123;</span><br><span class="line">      global.v8debug.Debug.setBreakPoint(compiledWrapper, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> args = [self.exports, <span class="built_in">require</span>, self, filename, dirname];  <span class="comment">//注意这里</span></span><br><span class="line">  <span class="keyword">return</span> compiledWrapper.apply(self.exports, args);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样一个js文件就被导入执行了，这里有一点要注意的是（上面注释有标明），exports原来是module的exports参数，为什么这么做，不直接传一个module对象或者将exports单独拿出来呢？原因主要有如下两点：</p>
<ul>
<li>达到require只引入一个类的效果</li>
<li>exports是形参引用，修改无效</li>
</ul>
<h3 id="node文件"><a href="#node文件" class="headerlink" title=".node文件"></a>.node文件</h3><p>.node的模块文件实际上是编写C/C++模块之后编译生成的，所以并不需要编译操作，加载和运行通过调用<code>process.dlopen()</code>方法来实现，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Native extension for .node</span></span><br><span class="line">Module._extensions[<span class="string">'.node'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">module, filename</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (manifest) &#123;</span><br><span class="line">    <span class="keyword">const</span> content = fs.readFileSync(filename);</span><br><span class="line">    <span class="keyword">const</span> moduleURL = pathToFileURL(filename);</span><br><span class="line">    manifest.assertIntegrity(moduleURL, content);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Be aware this doesn't use `content`</span></span><br><span class="line">  <span class="keyword">return</span> process.dlopen(<span class="built_in">module</span>, path.toNamespacedPath(filename));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>dlopen()在文件<code>src/node.cc</code>中有着相关实现，主要是依托于libuv库进行的封装，执行后.node中的对象传给exports返回给调用者。</p>
<p>.node文件模块因为是C/C++编译生成的，所以执行效率远高于.js文件模块，不过因为学习门槛高，流程复杂，大都更倾向于.js文件模块。</p>
<h3 id="json文件"><a href="#json文件" class="headerlink" title=".json文件"></a>.json文件</h3><p>最后说的是最简单的.json文件模块，调用<code>fs</code>模块同步读取文件内容后，通过调用内部方法<code>JSON.parse()</code>解析得到对象，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Native extension for .json</span></span><br><span class="line">Module._extensions[<span class="string">'.json'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">module, filename</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> content = fs.readFileSync(filename, <span class="string">'utf8'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (manifest) &#123;</span><br><span class="line">    <span class="keyword">const</span> moduleURL = pathToFileURL(filename);</span><br><span class="line">    manifest.assertIntegrity(moduleURL, content);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">module</span>.exports = <span class="built_in">JSON</span>.parse(stripBOM(content));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    err.message = filename + <span class="string">': '</span> + err.message;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>因为导入的模块会进行缓存，二次导入的时候直接读取缓存中的对象，所以这种文件模块导入的方式要优于在代码中进行导入的实现。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文主要是我在学习《深入浅出Node.js》一书中的学习笔记，是模块系列的第一篇，这一部分代码与最新的没什么区别，后续的源码也会继续沿用书中的老版本，毕竟没有人带路去读最新的node源码实在头疼，理解了书中的思想后续在对升级后的代码进行理解相比会舒服很多（自以为🌚）。</p>

          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/23/7-days-nodejs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/23/7-days-nodejs/" itemprop="url">七天学会nodejs整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-23T14:40:39+08:00">
                2020-02-23
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-02-24T01:01:22+08:00">
                2020-02-24
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node-js/" itemprop="url" rel="index">
                    <span itemprop="name">Node.js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.4k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  20 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>工作原因接触了NodeJS，开始学习它，不过以前对这门语言不了解，学习了基本语法可以工作后就没有加深学习了。时间长了后发现这门语言比我想象中强大了很多，于是开始准备全面了解，深入学习，本文是学习了<a href="http://nqdeng.github.io/7-days-nodejs/" target="_blank" rel="noopener">七天学会NodeJS</a>之后的一个整理总结，入门向的一篇文章，旨在让我们可以全面了解这门语言，有兴趣的可以参考。</p>
<h1 id="NodeJS基础"><a href="#NodeJS基础" class="headerlink" title="NodeJS基础"></a>NodeJS基础</h1><p>学习NodeJS，首先了解它是什么。</p>
<p>JS我们都知道–JavaScript，一门前端都在使用的脚本语言，而NodeJS就是运行在后端的js语言。换句话说，前端使用的JS是由浏览器进行解析运行的，而NodeJS就是一个独立的<strong>js解析器</strong>，随时随地，有node环境就可以解析运行。</p>
<p>NodeJS诞生的目的就是为了实现高性能的Web服务器（作者自己说的），至于为什么使用JS这门语言，主要有如下几点：</p>
<ol>
<li>JS这门语言自带的事件机制和异步IO模型（契合作者的需求）</li>
<li>同时JS没有自带的IO功能，不会有历史包袱（我理解是作者可以随意发挥）</li>
<li>有一大批前端程序员的拥护（用户众多）</li>
<li>chrome浏览器的v8高性能JS引擎的出现（可移植，有大哥维护）</li>
</ol>
<p>在这么多的优势的加护下，NodeJS也如作者期望的那样发展的欣欣向荣。</p>
<p>入门向的文章，安装运行少不了，不过原文已经很详细了，这里就不赘述了。</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/Nodejs基础1.png" alt="nodejs基础" style="zoom:50%;">

<p>（为什么思维导图放在中间了，因为以下就开始将知识点了=-=）</p>
<p><strong>模块</strong>是nodejs中很重要的一个概念，简单来说<strong>一个文件就是一个模块</strong>，文件名就是模块名。</p>
<p>模块中有三个预先定义好的变量：</p>
<ul>
<li>require: 加载其他模块</li>
<li>exports: 当前模块的导出对象</li>
<li>module: 当前模块的信息</li>
</ul>
<p>关于模块的内容后面会专门写一篇文章详细介绍，此处略过。</p>
<p>最后注意一下，Node有个<strong>缓存机制</strong>，会将require的模块中编译执行后的对象进行缓存，二次加载时使用缓存的对象。</p>
<h1 id="代码的组织和部署"><a href="#代码的组织和部署" class="headerlink" title="代码的组织和部署"></a>代码的组织和部署</h1><p>搭建房子首先要规划好房子结构，而稍微大一点的项目免不了要准备好代码的目录结构和部署方式，这一章主要是组织结构的介绍。</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200223163617.png" alt="代码的组织和部署" style="zoom:50%;">

<h2 id="模块解析规则"><a href="#模块解析规则" class="headerlink" title="模块解析规则"></a>模块解析规则</h2><p><strong>模块解析规则</strong>也就是模块导入的规则，主要分为三种</p>
<ul>
<li>内置模块</li>
<li>node_moudle模块</li>
<li>NODE_PATH环境变量</li>
</ul>
<p>原文说的很清楚了，这里补充的一点是查看当前的node_module目录可以参考如下方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200223165040.png" alt></p>
<h2 id="包"><a href="#包" class="headerlink" title="包"></a>包</h2><p><strong>包（PACKAGE）</strong>可以理解是多个模块的组合。复杂的模块往往由多个子模块组成，包就是多个子模块的集合。包中有两个重点：</p>
<ul>
<li>入口模块</li>
<li>package.json</li>
</ul>
<p>入口模块的导出对象是包的导出对象，因此我们可以直接导入入口对象就算是导入了整个包。</p>
<p>不过这样做并不够灵活，如果入口模块名字改了，所有导入它的代码都要跟着修改，因为我们引入了<strong>package.json</strong>。</p>
<p>最简单的package.json文件我们可以这样写:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"cat"</span>,</span><br><span class="line">    <span class="attr">"main"</span>: <span class="string">"./lib/main.js"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，加再模块时，只需要使用<code>require(&#39;/home/user/lib/cat&#39;)</code>的方式就可以了，Node会自己根据package.json的配置找到入口模块。</p>
<p>package.json还有其他的成员，一个完整的package.json可以如下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"name"</span>: <span class="string">"Hello World"</span>,</span><br><span class="line">	<span class="attr">"version"</span>: <span class="string">"0.0.1"</span>,</span><br><span class="line">	<span class="attr">"author"</span>: <span class="string">"张三"</span>,</span><br><span class="line">	<span class="attr">"description"</span>: <span class="string">"第一个node.js程序"</span>,</span><br><span class="line">	<span class="attr">"keywords"</span>:[<span class="string">"node.js"</span>,<span class="string">"javascript"</span>],</span><br><span class="line">	<span class="attr">"repository"</span>: &#123;</span><br><span class="line">		<span class="attr">"type"</span>: <span class="string">"git"</span>,</span><br><span class="line">		<span class="attr">"url"</span>: <span class="string">"https://path/to/url"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"license"</span>:<span class="string">"MIT"</span>,</span><br><span class="line">	<span class="attr">"engines"</span>: &#123;<span class="attr">"node"</span>: <span class="string">"0.10.x"</span>&#125;,</span><br><span class="line">	<span class="attr">"bugs"</span>:&#123;<span class="attr">"url"</span>:<span class="string">"http://path/to/bug"</span>,<span class="attr">"email"</span>:<span class="string">"bug@example.com"</span>&#125;,</span><br><span class="line">	<span class="attr">"contributors"</span>:[&#123;<span class="attr">"name"</span>:<span class="string">"李四"</span>,<span class="attr">"email"</span>:<span class="string">"lisi@example.com"</span>&#125;],</span><br><span class="line">	<span class="attr">"scripts"</span>: &#123;</span><br><span class="line">		<span class="attr">"start"</span>: <span class="string">"node index.js"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">		<span class="attr">"express"</span>: <span class="string">"latest"</span>,</span><br><span class="line">		<span class="attr">"mongoose"</span>: <span class="string">"~3.8.3"</span>,</span><br><span class="line">		<span class="attr">"handlebars-runtime"</span>: <span class="string">"~1.0.12"</span>,</span><br><span class="line">		<span class="attr">"express3-handlebars"</span>: <span class="string">"~0.5.0"</span>,</span><br><span class="line">		<span class="attr">"MD5"</span>: <span class="string">"~1.2.0"</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">		<span class="attr">"bower"</span>: <span class="string">"~1.2.8"</span>,</span><br><span class="line">		<span class="attr">"grunt"</span>: <span class="string">"~0.4.1"</span>,</span><br><span class="line">		<span class="attr">"grunt-contrib-concat"</span>: <span class="string">"~0.3.0"</span>,</span><br><span class="line">		<span class="attr">"grunt-contrib-jshint"</span>: <span class="string">"~0.7.2"</span>,</span><br><span class="line">		<span class="attr">"grunt-contrib-uglify"</span>: <span class="string">"~0.2.7"</span>,</span><br><span class="line">		<span class="attr">"grunt-contrib-clean"</span>: <span class="string">"~0.5.0"</span>,</span><br><span class="line">		<span class="attr">"browserify"</span>: <span class="string">"2.36.1"</span>,</span><br><span class="line">		<span class="attr">"grunt-browserify"</span>: <span class="string">"~1.3.0"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体每个字段介绍可以参考<a href="https://javascript.ruanyifeng.com/nodejs/packagejson.html" target="_blank" rel="noopener">JavaScript标准参考教程</a>。</p>
<h2 id="命令行程序"><a href="#命令行程序" class="headerlink" title="命令行程序"></a>命令行程序</h2><p>NodeJS可以编写命令行程序，只需要在程序前面加下如下内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/env node</span></span><br></pre></td></tr></table></figure>

<p>然后在<code>/usr/local/bin/</code>下添加一个软链接就可以实现了，下面是一个很简单的实例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200223171800.png" alt="node-hello"></p>
<p>Windows会有些不一样，我没用windows测试，这里也不介绍了，感兴趣自己看原文。</p>
<h2 id="工程目录"><a href="#工程目录" class="headerlink" title="工程目录"></a>工程目录</h2><p>代码的组织，可以参考如下布局：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- /home/user/workspace/node-echo/   # 工程目录</span><br><span class="line">    - bin/                          # 存放命令行相关代码</span><br><span class="line">        node-echo</span><br><span class="line">    + doc/                          # 存放文档</span><br><span class="line">    - lib/                          # 存放API相关代码</span><br><span class="line">        echo.js</span><br><span class="line">    - node_modules/                 # 存放三方包</span><br><span class="line">        + argv/</span><br><span class="line">    + tests/                        # 存放测试用例</span><br><span class="line">    package.json                    # 元数据文件</span><br><span class="line">    README.md                       # 说明文件</span><br></pre></td></tr></table></figure>

<p>没什么好聊的，只是个参考。</p>
<h2 id="NPM"><a href="#NPM" class="headerlink" title="NPM"></a>NPM</h2><p>NPM是NodeJS的包管理工具，常见的使用场景如下：</p>
<ul>
<li>允许用户从NPM服务器下载别人编写的三方包到本地使用。</li>
<li>允许用户从NPM服务器下载并安装别人编写的命令行程序到本地使用。</li>
<li>允许用户将自己编写的包或命令行程序上传到NPM服务器供别人使用。</li>
</ul>
<p>NPM搭建了NodeJS的生态圈。</p>
<p>这里有一点注意的，我们可以在之前的<code>package.json</code>文件中描述依赖的第三方包，直接通过<code>npm install</code>进行安装，避免了环境搭建的烦恼（很棒的功能）。</p>
<p><code>npm -l</code>可以看到都有哪些命令，想看命令的详细介绍也可以使用<code>npm help &lt;command&gt;</code>，文档非常全，这里就不赘述了。</p>
<h1 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h1><p>一个后端程序怎么能少得了文件操作。</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200223173140.png" alt="文件操作" style="zoom:50%;">

<p>文章有个copy文件的小程序很不错，可以引出一个知识点，程序如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy</span>(<span class="params">src, dst</span>) </span>&#123;</span><br><span class="line">    fs.createReadStream(src).pipe(fs.createWriteStream(dst));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">argv</span>) </span>&#123;</span><br><span class="line">    copy(argv[<span class="number">0</span>], argv[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line">main(process.argv.slice(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<p>程序很简单，这里说他主要是下面这个小知识点：</p>
<blockquote>
<p><code>process</code>是一个全局变量，可通过<code>process.argv</code>获得命令行参数。由于<code>argv[0]</code>固定等于NodeJS执行程序的绝对路径，<code>argv[1]</code>固定等于主模块的绝对路径，因此第一个命令行参数从<code>argv[2]</code>这个位置开始。</p>
</blockquote>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p>和文件相关的API有很多，这里拿出几个来对比</p>
<ul>
<li>Buffer</li>
<li>Stream</li>
<li>File System</li>
</ul>
<h3 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h3><p>Buffer类的官方解释:</p>
<blockquote>
<p><code>Buffer</code> 类的实例类似于从 <code>0</code> 到 <code>255</code> 之间的整数数组（其他整数会通过 <code>＆ 255</code> 操作强制转换到此范围），但对应于 V8 堆外部的固定大小的原始内存分配。 <code>Buffer</code> 的大小在创建时确定，且无法更改。</p>
</blockquote>
<p>在我看来，Buffer底层就是一个<code>unsigned char</code>类型的数组，申请所需的堆空间并存储二进制数据。</p>
<p>使用场景；</p>
<blockquote>
<p>多用于在 TCP 流、文件系统操作、以及其他上下文中与八位字节流进行交互。</p>
</blockquote>
<p>相关api使用去<a href="http://nodejs.cn/api/buffer.html" target="_blank" rel="noopener">官网</a>查看文档。</p>
<h3 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h3><p>照例来段官方解释：</p>
<blockquote>
<p>流（stream）是 Node.js 中处理流式数据的抽象接口。</p>
</blockquote>
<p>当内存中无法一次装下需要处理的数据时，或者一边读取一边处理更加高效时，我们就需要用到数据流。</p>
<p>流主要分为以下几种</p>
<ul>
<li>可读流</li>
<li>可写流</li>
<li>读写流</li>
<li>转换流 <a href="http://nodejs.cn/api/stream.html#stream_class_stream_transform" target="_blank" rel="noopener">Transform</a></li>
</ul>
<p>在node中，这四种流都是EventEmitter的实例，它们都有close、error事件，可读流具有监听数据到来的data事件等，可写流则具有监听数据已传给低层系统的finish事件等，<a href="http://nodejs.cn/api/stream.html#stream_class_stream_duplex" target="_blank" rel="noopener">Duplex</a> 和 <a href="http://nodejs.cn/api/stream.html#stream_class_stream_transform" target="_blank" rel="noopener">Transform</a> 都同时实现了 <a href="http://nodejs.cn/api/stream.html#stream_class_stream_readable" target="_blank" rel="noopener">Readable</a> 和 <a href="http://nodejs.cn/api/stream.html#stream_class_stream_writable" target="_blank" rel="noopener">Writable</a> 的事件和接口 。</p>
<p>当然，流也不是完美的，虽然消耗很少的内存，但那是比较理想的情况，如果读方没有尽快处理，会导致大量的数据被积压，而如何处理积压问题可以观看此文章<a href="https://nodejs.org/zh-cn/docs/guides/backpressuring-in-streams/" target="_blank" rel="noopener">数据流中的积压问题</a>，官方文档，童叟无欺。</p>
<h3 id="File-System"><a href="#File-System" class="headerlink" title="File System"></a>File System</h3><p>正经的文件操作模块。</p>
<p>fs模块提供的API基本操作分为三类：</p>
<ul>
<li>文件属性读写</li>
<li>文件内容读写</li>
<li>底层文件操作</li>
</ul>
<p>如下为一个简单而又典型的异步IO模型读取文件的示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(pathname, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="comment">// Deal with error.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Deal with data.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="网络操作"><a href="#网络操作" class="headerlink" title="网络操作"></a>网络操作</h1><p>千呼万唤始出来，终于到了网络模块。</p>
<p>先来个官方文档的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    response.writeHead(<span class="number">200</span>, &#123; <span class="string">'Content-Type'</span>: <span class="string">'text-plain'</span> &#125;);</span><br><span class="line">    response.end(<span class="string">'Hello World\n'</span>);</span><br><span class="line">&#125;).listen(<span class="number">8124</span>);</span><br></pre></td></tr></table></figure>

<p>这个是一个简单的HTTP服务器，打开浏览器访问该端口<code>http://127.0.0.1:8124/</code>就能够看到效果。</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200223193715.png" alt="网络操作" style="zoom:50%;">

<h2 id="API-1"><a href="#API-1" class="headerlink" title="API"></a>API</h2><p>与网络操作相关的API主要有如下几个：</p>
<ul>
<li>HTTP：网络服务核心模块</li>
<li>HTTP/2：h2版本</li>
<li>HTTPS：加密版本</li>
<li>URL：url解析</li>
<li>Zlib：提供了数据压缩和解压的功能</li>
<li>net：用于创建Socket服务器或Socket客户端</li>
</ul>
<p>下面介绍重点api：</p>
<h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>http模块是NodeJS中的核心模块，主要提供两种使用：</p>
<ul>
<li>作为服务端使用时，创建一个HTTP服务器，监听HTTP客户端请求并返回响应。</li>
<li>作为客户端使用时，发起一个HTTP客户端请求，获取服务端响应。</li>
</ul>
<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><p>本章刚开始的小例子就是一个服务端的实现，使用<code>.createServer</code>方法创建一个服务器，然后调用<code>.listen</code>方法监听端口，当有客户端请求过来时，就会有<code>request</code>事件被触发，调用回调函数进行返回。</p>
<p>HTTP请求本质是一个数据流，由请求头和请求体组成，默认大家都了解，这里不再赘述。</p>
<p>服务端也是继承自EventEmitter的，而它所提供的事件如下：</p>
<ul>
<li><p>request：当客户端请求到来时，该事件被触发，提供两个参数req和res，表示请求和响应信息。</p>
</li>
<li><p>connection：当TCP连接建立时，该事件被触发，提供一个参数socket，是net.Socket的实例。</p>
</li>
<li><p>close：当服务器关闭时，触发事件（注意不是在用户断开连接时）。</p>
</li>
</ul>
<p><em>注意</em>：request事件的参数req和res分别是<code>http.IncomingMessage</code>和<code>http.ServerResponse</code>的实例。</p>
<p><strong>http.IncomingMessage</strong>是HTTP请求的信，其提供了三个事件</p>
<ul>
<li>data：当请求体数据到来时，该事件被触发，该事件提供一个参数chunk，表示接受的数据，如果该事件没有被监听，则请求体会被抛弃，该事件可能会被调用多次（这与nodejs是异步的有关系）</li>
<li>end：当请求体数据传输完毕时，该事件会被触发，此后不会再有数据</li>
<li>close：用户当前请求结束时，该事件被触发，不同于end，如果用户强制终止了传输，也是用close</li>
</ul>
<p>而<strong>http.ServerResponse</strong>是返回给客户端的信息，决定了用户最终看到的内容，类似于上面，他有三个重要成员函数，用于返回响应头、内容以及结束请求：</p>
<ul>
<li><p>res.writeHead()：向请求的客户端发送响应头，该函数在一个请求中最多调用一次，如果不调用，则会自动生成一个响应头</p>
</li>
<li><p>res.write()：向请求的客户端发送相应内容，data是一个buffer或者字符串，如果data是字符串，则需要制定编码方式，默认为utf-8，在res.end调用之前可以多次调用</p>
</li>
<li><p>res.end())：结束响应，告知客户端所有发送已经结束，当所有要返回的内容发送完毕时，该函数必需被调用一次，两个可选参数与res.write()相同。如果不调用这个函数，客户端将用于处于等待状态。</p>
</li>
</ul>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>作为客户端就要简单很多了，先来个小栗子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">        hostname: <span class="string">'www.example.com'</span>,</span><br><span class="line">        port: <span class="number">80</span>,</span><br><span class="line">        path: <span class="string">'/upload'</span>,</span><br><span class="line">        method: <span class="string">'POST'</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">            <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> request = http.request(options, <span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;&#125;);</span><br><span class="line"></span><br><span class="line">request.write(<span class="string">'Hello World'</span>);</span><br><span class="line">request.end();</span><br></pre></td></tr></table></figure>

<p>这里用到了<code>http.request</code>，另一个函数为<code>http.get</code>，功能是作为客户端向http服务器发起请求。</p>
<p>因为<code>GET</code>请求不需要请求体，所以请求不太一样，再来个小栗子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.get(&apos;http://www.example.com/&apos;, function (response) &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>也没什么好介绍的了，详细介绍看官方文档吧。</p>
<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p><code>https</code>模块与<code>http</code>模块极为类似，区别在于<code>https</code>模块需要额外处理SSL证书。</p>
<p>在服务端模式下，创建一个HTTPS服务器的示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var options = &#123;</span><br><span class="line">        key: fs.readFileSync(&apos;./ssl/default.key&apos;),</span><br><span class="line">        cert: fs.readFileSync(&apos;./ssl/default.cer&apos;)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">var server = https.createServer(options, function (request, response) &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>可以看到，与创建HTTP服务器相比，多了一个<code>options</code>对象，通过<code>key</code>和<code>cert</code>字段指定了HTTPS服务器使用的私钥和公钥。</p>
<p>HTTPS与HTTP的区别这里就不介绍了，后面会专门出一篇文章，感兴趣的小伙伴也可以自己去查，网上有很多相关文章。</p>
<h1 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h1><p>NodeJS可以感知和控制自身进程的运行环境和状态，也可以创建子进程并与其协同工作，这使得NodeJS可以把多个程序组合在一起共同完成某项工作，并在其中充当胶水和调度器的作用。</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200223232838.png" alt="进程管理" style="zoom:50%;">

<h2 id="API-2"><a href="#API-2" class="headerlink" title="API"></a>API</h2><p>进程管理有关的API如下：</p>
<ul>
<li>process: 当前进程管理</li>
<li>child_process: 创建和控制子进程</li>
<li>cluster: 对<code>child_process</code>模块的封装，充分利用多核CPU</li>
</ul>
<h3 id="process"><a href="#process" class="headerlink" title="process"></a>process</h3><p>process是一个全局对象，提供了当前NodeJS进程的信息并可以对其进行控制，以下为process所提供的一系列属性：</p>
<ul>
<li><code>process.argv</code>：返回一个数组，成员是当前进程的所有命令行参数。</li>
<li><code>process.env</code>：返回一个对象，成员为当前Shell的环境变量，比如<code>process.env.HOME</code>。</li>
<li><code>process.installPrefix</code>：返回一个字符串，表示 Node 安装路径的前缀，比如<code>/usr/local</code>。相应地，Node 的执行文件目录为<code>/usr/local/bin/node</code>。</li>
<li><code>process.pid</code>：返回一个数字，表示当前进程的进程号。</li>
<li><code>process.platform</code>：返回一个字符串，表示当前的操作系统，比如<code>Linux</code>。</li>
<li><code>process.title</code>：返回一个字符串，默认值为<code>node</code>，可以自定义该值。</li>
<li><code>process.version</code>：返回一个字符串，表示当前使用的 Node 版本，比如<code>v7.10.0</code>。</li>
</ul>
<p>当然，还有各种事件以及成员方法，方法简要说下吧，事件自己去看。</p>
<ul>
<li><code>process.chdir()</code>：切换工作目录到指定目录。</li>
<li><code>process.cwd()</code>：返回运行当前脚本的工作目录的路径。</li>
<li><code>process.exit()</code>：退出当前进程。</li>
<li><code>process.getgid()</code>：返回当前进程的组ID（数值）。</li>
<li><code>process.getuid()</code>：返回当前进程的用户ID（数值）。</li>
<li><code>process.nextTick()</code>：指定回调函数在当前执行栈的尾部、下一次Event Loop之前执行。</li>
<li><code>process.on()</code>：监听事件。</li>
<li><code>process.setgid()</code>：指定当前进程的组，可以使用数字ID，也可以使用字符串ID。</li>
<li><code>process.setuid()</code>：指定当前进程的用户，可以使用数字ID，也可以使用字符串ID。</li>
</ul>
<h3 id="child-process"><a href="#child-process" class="headerlink" title="child_process"></a>child_process</h3><p>child_process模块用来创建和控制子进程，其核心方法为<code>child_process.spawn()</code>，常用的四个方法如下：</p>
<ul>
<li>exec：用于执行bash命令，它的参数是一个命令字符串。</li>
<li>execFile：直接执行特定的程序，参数作为数组传入，不会被bash解释</li>
<li>fork：创建一个子进程，执行Node脚本</li>
<li>spawn：创建一个子进程来执行特定命令，没有回调函数</li>
</ul>
<p>每个都有自己的用途，一个简单的实例如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">'child_process'</span>).exec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ls = exec(<span class="string">'ls -l'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, stdout, stderr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(error.stack);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Error code: '</span> + error.code);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Child Process STDOUT: '</span> + stdout);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>具体介绍和使用官方写的很详细了，不过有一段话这里可以介绍下</p>
<blockquote>
<p><a href="http://nodejs.cn/s/N6uK8q" target="_blank" rel="noopener"><code>child_process.execFile()</code></a>: 类似于 <a href="http://nodejs.cn/s/pkpJMy" target="_blank" rel="noopener"><code>child_process.exec()</code></a>，但是默认情况下它会直接衍生命令而不先衍生 shell。</p>
</blockquote>
<p>这是一段对execFile的介绍，看到这里后对这段话很不理解，于是去查看了源码，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeExecArgs</span>(<span class="params">command, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) &#123;</span><br><span class="line">    callback = options;</span><br><span class="line">    options = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make a shallow copy so we don't clobber the user's options object.</span></span><br><span class="line">  options = &#123; ...options &#125;;</span><br><span class="line">  options.shell = <span class="keyword">typeof</span> options.shell === <span class="string">'string'</span> ? options.shell : <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    file: command,</span><br><span class="line">    options: options,</span><br><span class="line">    callback: callback</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params">command, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> opts = normalizeExecArgs(command, options, callback);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>.exports.execFile(opts.file,</span><br><span class="line">                                 opts.options,</span><br><span class="line">                                 opts.callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段是exec()方法的实现，可以看到是调用了execFile();</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200224002411.png" alt="execFile" style="zoom:67%;">

<p>官网中对shell参数有如上图描述，在上述代码中我们可以看到exec()传进来的默认为true，所以会启动shell，也就是可以执行一些shell命令和脚本，而execFile()默认为false，则不会启动shell，可以执行一些可运行的程序，效率会高过exec()。</p>
<h3 id="cluster"><a href="#cluster" class="headerlink" title="cluster"></a>cluster</h3><p>cluster意为集群，表示多个Node进程构成的服务。cluster封装了child_process.fork方法创建node子进程.。利用cluster模块，我们可以创建多进程的Web服务器，充分利用多核处理器的计算资源。下面给出一个具体示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cluster = <span class="built_in">require</span>(<span class="string">'cluster'</span>);</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> numCPUs = <span class="built_in">require</span>(<span class="string">'os'</span>).cpus().length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cluster.isMaster) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`主进程 <span class="subst">$&#123;process.pid&#125;</span> 正在运行`</span>);</span><br><span class="line">  <span class="comment">// 衍生工作进程。</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class="line">    cluster.fork();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cluster.on(<span class="string">'exit'</span>, (worker, code, signal) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`工作进程 <span class="subst">$&#123;worker.process.pid&#125;</span> 已退出`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 工作进程可以共享任何 TCP 连接。</span></span><br><span class="line">  <span class="comment">// 在本例子中，共享的是一个 HTTP 服务器。</span></span><br><span class="line">  http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>);</span><br><span class="line">    res.end(<span class="string">'你好世界\n'</span>);</span><br><span class="line">  &#125;).listen(<span class="number">8000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`工作进程 <span class="subst">$&#123;process.pid&#125;</span> 已启动`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们将master称为主进程，worker进程称为工作进程，利用cluster模块，使用Node的cluster模块封装好的API、IPC通道和调度机制可以非常简单的创建包括一个master进程下HTTP代理服务器 + 多个worker进程多个HTTP应用服务器的架构。</p>
<p>我们可以看到多个子进程共同监听了同一端口，这是违背规则的，那么Node是如何实现的呢？<br>这是因为，子进程并没有创建ServerSocket作监听，而是交由父进程创建ServerSocket监听指定端口，接收到连接后创建Socket，而得到的请求会根据<strong>“指定的分发规则”</strong>通过IPC发送给子进程，子进程处理后的结果再通过IPC由父进程转发给请求方。</p>
<p>最后，cluster的请求分发策略有两种：</p>
<ul>
<li>Round-Robin法：即轮询，依次循环将请求分配给子线程。</li>
<li>共享服务端socket方式：由操作系统进行调度。</li>
</ul>
<p>cluster的底层对master和child有着不同的实现：</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200224003147.png" alt="cluster" style="zoom:70%;">

<p>上图为cluster实现的源码，具体原理还需要对其进行源码解读。</p>
<h1 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h1><p>先来说异步是什么，我的理解是：</p>
<blockquote>
<p>异步就是有事件发生找个人去处理，自己继续忙自己的任务，等那个人处理完了通知到你，你再验收。</p>
</blockquote>
<p>我们都知道，Node是单线程的，可是如果是单线程，又如何完成异步机制和事件机制呢？</p>
<p>实际上，NodeJS的单线程是指的只有一个主线程，其他线程包括而不限于如下几种：</p>
<ul>
<li>js引擎执行线程</li>
<li>定时器线程</li>
<li>异步IO线程</li>
</ul>
<p>这些线程可以称之为工作线程，这种机制避免了node因为线程切换造成的损耗，使得Node非常适合IO密集型应用。而本章的异步编程主要是创建工作线程与主线程并发执行，但需要等主线程空闲时才能执行回调函数。</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/20200223232927.png" alt="异步编程" style="zoom:50%;">

<h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>在代码中，异步编程的直接体现就是回调。异步编程依托于回调来实现，但不能说使用了回调后程序就异步化了，比如如下程序：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">heavyCompute</span>(<span class="params">n, callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>,</span><br><span class="line">    <span class="keyword">var</span> i, j;</span><br><span class="line">    <span class="keyword">for</span> (i = n; i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = n; j &gt; <span class="number">0</span>; --j) &#123;</span><br><span class="line">            count += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    callback(count);</span><br><span class="line">&#125;</span><br><span class="line">heavyCompute(<span class="number">10000</span>, <span class="function"><span class="keyword">function</span> (<span class="params">count</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(count);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'hello'</span>);</span><br><span class="line"></span><br><span class="line">-- Console ------------------------------</span><br><span class="line"><span class="number">100000000</span></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

<p>显然，并没有异步执行，那如果想写一个异步的程序需要怎么写呢，学到的一个很简单的实例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'world'</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'hello'</span>);</span><br><span class="line"></span><br><span class="line">-- Console ------------------------------</span><br><span class="line">hello</span><br><span class="line">world</span><br></pre></td></tr></table></figure>

<p>通过调用setTimeout()这个原生的异步函数来实现异步。</p>
<p>你说这耍赖，不是你自己实现的，那再来个异步遍历数组的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">i, len, count, callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; len; ++i) &#123;</span><br><span class="line">        (<span class="function"><span class="keyword">function</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">async</span>(arr[i], <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">                arr[i] = value;</span><br><span class="line">                <span class="keyword">if</span> (++count === len) &#123;</span><br><span class="line">                    callback();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;(<span class="number">0</span>, arr.length, <span class="number">0</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// All array items have processed.</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>看到这里就结束了，有人可能好奇，不是七天么，这不是才六章吗？</p>
<p>第七天是个综合示例，自己照着敲学习吧🤪。</p>
<h1 id="引用文献"><a href="#引用文献" class="headerlink" title="引用文献"></a>引用文献</h1><p><a href="http://nqdeng.github.io/7-days-nodejs/" target="_blank" rel="noopener">七天学会NodeJS</a></p>
<p><a href="http://nodejs.cn/api/" target="_blank" rel="noopener">官方文档（中文版）</a></p>
<p><a href="https://www.jianshu.com/p/d51979a090b5" target="_blank" rel="noopener">node.js模块简明详解</a></p>
<p><a href="https://javascript.ruanyifeng.com/nodejs/packagejson.html" target="_blank" rel="noopener">JavaScript标准参考教程</a></p>
<p><a href="https://segmentfault.com/a/1190000011968267" target="_blank" rel="noopener">认识node核心模块–从Buffer、Stream到fs</a></p>
<p><a href="https://www.zcfy.cc/article/node-js-streams-everything-you-need-to-know-freecodecamp-3913.html" target="_blank" rel="noopener">Node.js中的流（Streams）：你需要知道的一切 </a></p>
<p><a href="https://www.jianshu.com/p/ab2741f78858" target="_blank" rel="noopener">浅析nodejs的http模块</a></p>
<p><a href="https://www.jianshu.com/p/74991d15133c" target="_blank" rel="noopener">Node的进程详解</a></p>

          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/26/缓存相关问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/26/缓存相关问题/" itemprop="url">缓存相关问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-26T16:07:32+08:00">
                2019-12-26
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-12-26T16:07:36+08:00">
                2019-12-26
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/other/" itemprop="url" rel="index">
                    <span itemprop="name">other</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  294 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h1><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>查到DB和缓存都没有的数据</p>
<h2 id="带来的问题"><a href="#带来的问题" class="headerlink" title="带来的问题"></a>带来的问题</h2><p>大量DB和缓存都不存在的数据请求打到数据库，会加大数据库压力，严重发生宕机。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="缓存空值"><a href="#缓存空值" class="headerlink" title="缓存空值"></a>缓存空值</h3><p>如果数据库不存在则在缓存中加入key与null的关系，后续由缓存将null返回给用户</p>
<h3 id="BloomFilter"><a href="#BloomFilter" class="headerlink" title="BloomFilter"></a>BloomFilter</h3><p>Bloom Filter是一个很长的二进制向量和一系列随机映射函数，它可以判断数据是否存在。当前场景我们可以用它来判断查询的数据是否在集合中。</p>
<img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/bloomfilter.png" alt="bloomfilter" style="zoom:50%;">

<p>如上图，在缓存上增加一层BloomFilter，进行筛选，不存在直接返回null</p>
<h1 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h1><h2 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h2><p>大量的请求到缓存没有的数据（DB有）</p>
<h2 id="带来的问题-1"><a href="#带来的问题-1" class="headerlink" title="带来的问题"></a>带来的问题</h2><p>加大数据库压力，严重发生宕机</p>
<h2 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h2><p>加上锁，第一个取完后放入缓存，后面的去缓存取数据</p>
<h1 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h1><h2 id="原因-2"><a href="#原因-2" class="headerlink" title="原因"></a>原因</h2><p>缓存服务崩溃</p>
<h2 id="带来的问题-2"><a href="#带来的问题-2" class="headerlink" title="带来的问题"></a>带来的问题</h2><p>加大数据库压力，严重发生宕机</p>
<h2 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h2><ol>
<li>增加高可用（事后）</li>
<li>本地缓存</li>
<li>限流</li>
<li>服务降级（返回默认值）</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/25/Java_basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/25/Java_basic/" itemprop="url">JAVA基础知识(持续更新)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-25T14:06:07+08:00">
                2019-12-25
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-12-25T14:06:18+08:00">
                2019-12-25
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  742 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="语法基础"><a href="#语法基础" class="headerlink" title="语法基础"></a>语法基础</h1><h1 id="编程思想"><a href="#编程思想" class="headerlink" title="编程思想"></a>编程思想</h1><h2 id="类与对象"><a href="#类与对象" class="headerlink" title="类与对象"></a>类与对象</h2><p>###Object</p>
<p>概念</p>
<blockquote>
<p>超父类，所有类的源头，如果不写继承则默认继承Object</p>
</blockquote>
<p>方法</p>
<blockquote>
<p>registNatives(): native修饰，</p>
<p>getClass():</p>
<p>hashCode():</p>
<p>equals():</p>
<p>clone():</p>
<p>toString():</p>
<p>notify():</p>
<p>notifyAll():</p>
<p>wait(…):</p>
<p>finalize():</p>
</blockquote>
<h3 id="this"><a href="#this" class="headerlink" title="this"></a>this</h3><p>概念</p>
<blockquote>
<p>当前类的指针（是个对象吧？）</p>
</blockquote>
<p>原理</p>
<blockquote>
<p>?</p>
</blockquote>
<h3 id="super"><a href="#super" class="headerlink" title="super"></a>super</h3><p>概念</p>
<blockquote>
<p>表示父类的引用</p>
</blockquote>
<p>原理</p>
<blockquote>
<p>?</p>
</blockquote>
<h3 id="抽象"><a href="#抽象" class="headerlink" title="抽象"></a>抽象</h3><p>概念</p>
<blockquote>
<p>类为抽象的概念</p>
</blockquote>
<p>分类</p>
<blockquote>
<p><strong>抽象类：</strong>由abstract修饰的类，不能被实例化</p>
<p><strong>抽象方法：</strong>用abstract修饰的方法，只能由子类进行实现</p>
</blockquote>
<h3 id="native"><a href="#native" class="headerlink" title="native"></a>native</h3><p>概念</p>
<blockquote>
<p>A native method is a Java method whose implementation is provided by non-java code.</p>
<p>一般为c/c++实现，使用JNI(java native interface)进行通信</p>
</blockquote>
<p>使用规则</p>
<blockquote>
<ol>
<li>native标识符除不能与abstract联用外，可以与其它标识符联用；</li>
<li>native method方法可以返回任何java类型，包括非基本类型，也可以进行异常控制；</li>
<li>如果含有native method方法的类被继承，子类会继承这个native method方法，也可以使用java语言重写 这个方法；</li>
<li>如果一个native method方法被fianl标识，它被继承后不能被重写。</li>
</ol>
</blockquote>
<p>实现步骤</p>
<blockquote>
<ol>
<li><p>在Java中声明<code>native()</code>方法,然后编译；</p>
</li>
<li><p>使用javah命令生成.h文件；</p>
</li>
<li><p>编写.cpp文件实现native导出方法，其中需要包含第二步产生的.h文件（注意其中需包含JDK带的jni.h文件）；</p>
</li>
<li><p>将本地代码编译成动态库（Windows：<em>.dll，linux/unix：</em>.so，mac os x：*.jnilib）；</p>
</li>
<li><p>Java中使用System.loadLibrary()方法加载第四步产生的动态链接库文件，至此，整个过程结束。</p>
</li>
</ol>
</blockquote>
<h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><p>概念</p>
<blockquote>
<p>隐藏细节，开放给用户安全的接口</p>
</blockquote>
<p>权限访问控制</p>
<blockquote>
<p><strong>权限关键字：</strong>public、protected、default（不填一样）、private</p>
<p>权限依次降低</p>
</blockquote>
<table>
<thead>
<tr>
<th>作用域</th>
<th>当前类</th>
<th>同一package普通类</th>
<th>其他package普通类</th>
<th>同一package子孙类</th>
<th>其他package子孙类</th>
</tr>
</thead>
<tbody><tr>
<td>public</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>protected</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>默认</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>×</td>
</tr>
<tr>
<td>private</td>
<td>√</td>
<td>×</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
</tbody></table>
<p>原理</p>
<blockquote>
<p>?</p>
</blockquote>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><p>概念</p>
<blockquote>
<p>子类继承父类的属性和方法、减少了重复代码、增加了类结构关系</p>
</blockquote>
<p>注意点</p>
<blockquote>
<ol>
<li>继承的抽象方法必须实现</li>
<li>只能继承父类非private权限的，具体看上面的权限表格</li>
</ol>
</blockquote>
<p><strong>原理</strong></p>
<blockquote>
<p>?</p>
</blockquote>
<h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><p>概念</p>
<blockquote>
<p>子类对父类方法的不同实现</p>
</blockquote>
<p>条件</p>
<blockquote>
<ol>
<li>父类抽象方法</li>
<li>多个子类不同实现</li>
<li>使用父类类型接收子类对象，并进行调用</li>
</ol>
</blockquote>
<p>原理</p>
<blockquote>
<p>？</p>
<p>函数指针指向不同的方法实现</p>
</blockquote>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p>概念</p>
<blockquote>
<p>规范使用，规定一套标准的用法</p>
</blockquote>
<p>详解</p>
<blockquote>
<ol>
<li>接口所有方法为抽象类</li>
<li>接口中的属性为public final类型的（不写也是）</li>
<li>接口是制定适用规范，如对虚拟文件系统对外的增删改查标准接口</li>
</ol>
</blockquote>
<h1 id="Java容器"><a href="#Java容器" class="headerlink" title="Java容器"></a>Java容器</h1><ul>
<li><input disabled type="checkbox"> Collection<ul>
<li><input disabled type="checkbox"> List<ul>
<li><input disabled type="checkbox"> LinkedList</li>
<li><input disabled type="checkbox"> ArrayList</li>
<li><input disabled type="checkbox"> Vector</li>
</ul>
</li>
<li><input disabled type="checkbox"> Stack</li>
<li><input disabled type="checkbox"> Set<ul>
<li><input disabled type="checkbox"> HashSet</li>
</ul>
</li>
<li><input disabled type="checkbox"> LinkedHashSet<ul>
<li><input disabled type="checkbox"> TreeSet</li>
</ul>
</li>
<li><input disabled type="checkbox"> Queue<ul>
<li><input disabled type="checkbox"> PriorityQueue</li>
</ul>
</li>
</ul>
</li>
<li><input disabled type="checkbox"> Map<ul>
<li><input disabled type="checkbox"> TreeMap</li>
<li><input disabled type="checkbox"> </li>
<li><input disabled type="checkbox"> HashMap<ul>
<li><input disabled type="checkbox"> LinkedHashMap</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p>如下为java容器分类图（粗体为重点容器）</p>
<p><img src="https://images0.cnblogs.com/i/617995/201404/161353012916056.png" alt="java容器分类图"></p>
<h1 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h1><h1 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h1><h1 id="I-O"><a href="#I-O" class="headerlink" title="I/O"></a>I/O</h1><ul>
<li><input disabled type="checkbox"> <p>文件操作</p>
</li>
<li><input disabled type="checkbox"> <p>标准输入输出</p>
</li>
<li><input disabled type="checkbox"> <p>linux IO模式</p>
<blockquote>
<p><a href="https://segmentfault.com/a/1190000003063859" target="_blank" rel="noopener">linux IO模式</a></p>
</blockquote>
</li>
</ul>
<h1 id="注解与反射"><a href="#注解与反射" class="headerlink" title="注解与反射"></a>注解与反射</h1><h1 id="图形化界面"><a href="#图形化界面" class="headerlink" title="图形化界面"></a>图形化界面</h1>
          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/25/git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/25/git/" itemprop="url">Git内部原理介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-25T11:56:21+08:00">
                2019-12-25
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-12-26T11:57:35+08:00">
                2019-12-26
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/git/" itemprop="url" rel="index">
                    <span itemprop="name">git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.3k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文主要是介绍Git内部原理，包含底层命令与文件系统两部分，旨在让我们从了解Git底层原理的运作，从而更好的使用。本文适用于有一定Git基础，并且对Git实现原理比较好奇的同学。</p>
<h1 id="Git-文件系统简介"><a href="#Git-文件系统简介" class="headerlink" title="Git 文件系统简介"></a>Git 文件系统简介</h1><p>首先，先说个概念：</p>
<blockquote>
<p>Git文件系统是<strong>内容寻址文件系统</strong>。</p>
</blockquote>
<p>内容寻址文件系统是什么？</p>
<p>简单来说就是一个<strong>键值对数据库</strong>，你可以向数据库中插入任意类型的内容，它会返回一个键值，你可以通过这个键值再次检索插入的内容。</p>
<p>有没有点感觉了，没有也没关系，我们先来分析研究Git文件系统的内容，找到我们想要的答案。</p>
<p>如何得到Git文件系统？</p>
<p>首先，新建个文件夹，如<code>mkdir mygit</code>，进入文件夹后使用<code>git init</code>命令，初始化Git后得到<code>.git</code>文件夹，这个就是我们的文件系统实体，具体操作如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/Git%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-1.png" alt="git文件系统"></p>
<p>可以看到.git文件夹下已经有很多内容，相关介绍如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/git_file.png" alt="git_file"></p>
<p>可以看到每个文件或者目录对应的介绍，这里面我们重点关注的主要有<strong>HEAD、objects以及refs</strong>等三个内容，在介绍他们前，我们先了解<strong>底层命令</strong>，用它来打开我们走进Git内部的大门。</p>
<h1 id="Git底层命令"><a href="#Git底层命令" class="headerlink" title="Git底层命令"></a>Git底层命令</h1><p>通过<code>git help</code>可以查看高级命令及相关介绍，而如果我们想看底层命令，可以通过命令<code>git help -g</code>，下面是一些常用底层命令：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/%E5%BA%95%E5%B1%82%E5%91%BD%E4%BB%A4-1.png" alt="git底层命令"></p>
<p>了解底层命令可以让我们更直观的理解git的工作原理，比如我们平时操作的<code>git add &amp; git commit</code>其实可以用底层命令实现，如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/commit_command.png" alt="git commit"></p>
<p>上图为一个新建的git仓库，通过使用内部命令<code>hash-object、update-index、write-tree、commit-tree</code>等实现了我们的添加和提交的功能，这几部的作用依次是：</p>
<ol>
<li>hash-object 得到test1文件对象的键值</li>
<li>updata-index将test1添加到暂存区（实现了add操作）</li>
<li>write-tree命令将暂存区内容写入到一个树对象中（这里提到了对象，下面来介绍对象）</li>
<li>最后通过commit-tree命令将树对象提交得到一个提交对象（实现了commit操作）</li>
</ol>
<p>用底层命令需要四部才能完成我们的工作（其实还有第五步，后面讲文件系统在介绍），而我们平时用的高级命令<code>add、commit</code>只需要两步，这么一比确实高级了很多，但通过这四步，我们可以理解下之前我说的Git就是个键值对数据库这个概念是不是理解了很多，Git所有的文件都可以由生成的键值取出，如下图：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ /home/gewuang/profile/mygit git:(master) ✗ &gt; git cat-file -p \</span><br><span class="line">										ce013625030ba8dba906f756967f9e9ca394464a</span><br><span class="line">hello</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(master) ✗ &gt;</span><br></pre></td></tr></table></figure>

<p>这个键值<code>ce013625030ba8dba906f756967f9e9ca394464a</code>就是我们上面由<code>hash-object</code>生成的。</p>
<h1 id="Git对象"><a href="#Git对象" class="headerlink" title="Git对象"></a>Git对象</h1><p>对象是Git文件系统的基础，可分为<strong>树对象、数据对象、提交对象、标签对象</strong>等四种，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/git%E5%AF%B9%E8%B1%A1-1.jpg" alt="git对象"></p>
<p><strong>数据对象</strong>就是linux系统中的inode节点（详情看上篇<a href="/2019/12/21/inode/">inode介绍</a>），只存储文件中的内容，数据对象的名字就是它的”inode节点”，也就是索引节点，而文件名等信息则存放在<strong>树对象</strong>中，对比linux系统就是目录文件，<strong>提交对象</strong>当然就是我们的commit_id了，这也是我们平时接触最多的，下图为对象中的内容：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/git_object.png" alt="git object"></p>
<p>上图主要使用底层命令<code>cat-file</code>获取对象信息，首先用<code>-p</code>选项打印对象中文件的内容，然后用<code>-t</code>打印对象类型。可以看到首先打印的是blob类型，也就是数据对象的内容，然后是树对象内容，最后是提交对象的内容，这里可以看到tree就是我们当时提交时使用的树对象的键值。下面为具体格式介绍：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/git_object2.png" alt="git object2"></p>
<p>这里为什么没有tag对象，因为tag对象内容就是我们使用<code>git tag *</code>时标签的commit id，如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/git_tag.png" alt="git tag"></p>
<h1 id="Git文件系统原理"><a href="#Git文件系统原理" class="headerlink" title="Git文件系统原理"></a>Git文件系统原理</h1><p>介绍完了git底层命令和git对象，我们可以回头再来看Git文件系统原理了。</p>
<p>首先填前面的第一个坑，.git目录下我们关注的三个内容：<strong>HEAD、objects/以及refs/</strong>。</p>
<h2 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a>HEAD</h2><p><strong>HEAD</strong>存放的是我们当前的分支信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt; ls</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt; cat .git/HEAD</span><br><span class="line">ref: refs/heads/master</span><br></pre></td></tr></table></figure>

<p>当我们新建一个分支后，切换当前分支可以发现HEAD内容已经被改变</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt; git branch branch1</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt; git co branch1</span><br><span class="line">Switched to branch &apos;branch1&apos;</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(branch1) &gt; cat .git/HEAD</span><br><span class="line">ref: refs/heads/branch1</span><br></pre></td></tr></table></figure>

<p>当然我们可以直接修改HEAD文件来更改分支，不过这样是不推荐的，你可以骚一点，用底层命令<code>symbolic-ref</code>来进行修改，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ /home/gewuang/profile/mygit git:(branch1) &gt; cat .git/HEAD</span><br><span class="line">ref: refs/heads/branch1</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(branch1) &gt; git symbolic-ref HEAD refs/heads/master</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt; cat .git/HEAD</span><br><span class="line">ref: refs/heads/master</span><br></pre></td></tr></table></figure>

<h2 id="objects"><a href="#objects" class="headerlink" title="objects/"></a>objects/</h2><p><strong>objects/</strong>目录下存放着我们的数据对象、树对象以及提交对象等等</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt; find .git/objects -type f</span><br><span class="line">.git/objects/2e/4f59e4b1040fca028e89fe687909373463607a</span><br><span class="line">.git/objects/74/9b9d6b710c728b0296098c2f4c3d883566af08</span><br><span class="line">.git/objects/ce/013625030ba8dba906f756967f9e9ca394464a</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，我们之前操作的对象，都在这里存着，存放的格式为前两位作为目录名，后续内容作为文件名，这个文件是由zlib压缩过的，我们一般通过<code>cat-file</code>命令进行查看。</p>
<h2 id="refs"><a href="#refs" class="headerlink" title="refs/"></a>refs/</h2><p><strong>refs/</strong>目录放置的是引用文件，先收下我对引用的理解：存储指向数据（提交）对象的<strong>指针</strong>。</p>
<p>对，我理解的引用文件就是指针，里面存放的内容就是键值，可以直接找到对应的对象文件，拿到想要的内容，引用的分类和介绍如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/git_refs.png" alt="refs"></p>
<p>HEAD我认为也是一种引用，不过它比较特殊，是<strong>符号引用</strong>，因为它存放的内容为就是文件路径，如master的<code>refs/heads/master</code>，像极了软链接的样子。</p>
<p>这里的<strong>refs/head/master</strong>的内容就是我们当前分支的键值了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt; cat .git/refs/heads/master</span><br><span class="line">749b9d6b710c728b0296098c2f4c3d883566af08</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt; git gl</span><br><span class="line">749b9d6 [2019-12-25 22:16:45 +0800]  &lt;gewuang&gt; (HEAD -&gt; master, branch1) first commit</span><br><span class="line">➜ /home/gewuang/profile/mygit git:(master) &gt;</span><br></pre></td></tr></table></figure>

<p><code>remote/</code>主要是远程引用相关的，这里不多介绍。</p>
<h2 id="包文件"><a href="#包文件" class="headerlink" title="包文件"></a>包文件</h2><p>git存放数据对象的时候会把整个文件都存到数据对象中，即使有zlib压缩，你可能也会疑惑，我项目这么大，这么多提交，.git目录不是早就爆掉了么，你能想到的设计的人肯定也想到的，所以就有了包文件，他存在的意义就是将对象进行打包，节省空间。</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/git_packet.png" alt="packet"></p>
<p>上图介绍的很清楚了（请自动把引用两个字替换成packet，笔误），不过还有一点注意的是相同的文件修改后的数据对象打包后，前一个对象保存的是差异，而文件的全部内容存放在包中此文件最新的数据对象中，因为git认为最新的是人们访问几率最大的，这个设计是为了节省计算的时间，提高效率。</p>
<h2 id="Git组织结构"><a href="#Git组织结构" class="headerlink" title="Git组织结构"></a>Git组织结构</h2><p>讲了这么多，那么git组织结构是什么样的呢？看下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/gewuang/cloudimg/data/git_fs.png" alt="git_fs"></p>
<p>文章很长了，不详细介绍了，看不懂就去翻上面，动动脑子去理解才能吸收。</p>
<p>看到这里的都是好孩子，给你个奖励，我自己的一套git别名，用起来会方便很多，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[alias]</span><br><span class="line">    glf  = log -n 10 --name-only  --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset</span><br><span class="line">    gl  = log -n 30 --date-order  --format=\"%Cgreen%h %Cred[%ci] %Creset &lt;%an&gt;%C(yellow)%d%Creset %Creseset \"</span><br><span class="line">    gll  = log -n 30  --format=\"%Cgreen%H %Cred[%ci] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset \"</span><br><span class="line">    gl3 = log -n 20  --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset \" --graph</span><br><span class="line">    gl2 = log --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset \"</span><br><span class="line">    glc = log --format=\"%Cgreen%h %Cred[%cd] %Creset&lt;committer:%cn&gt; : %Cred[%ad] %Creset&lt;author:%cn&gt; %C</span><br><span class="line">    glc2 = log --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;committer:%cn&gt; : %Cred[%ai] %Creset&lt;author:%cn&gt; %</span><br><span class="line">    glc3 = log --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;committer:%cn&gt; : %Cred[%ai] %Creset&lt;author:%cn&gt; %</span><br><span class="line">            glw = log  -n 20  --format=\"%Cgreen%h %Cred[%ci] %Creset&lt;%an&gt; %Creset %n%Cgreen%s%Creset%n%b  \"</span><br><span class="line">    #| grep \"+0800]\"</span><br><span class="line">    gldetail = log --format=\"%h `[%cd] `&lt;committer:%cn&gt; `[%ad] `&lt;author:%an&gt; ` %s \"</span><br><span class="line">    hist = log --pretty=format:\"%C(yellow)%h %C(red)%d %C(reset)%s %C(green)[%an] %C(blue)%ad\" --topo-order --graph latest = for-each-ref --sort=-committerdate --format=\"%(committername)@%(refname:short) [%(committerdate:short)] %(contents)\"</span><br><span class="line">        #gldetail = log --format=\"%h [%cd] &lt;committer:%cn&gt; :[%ad] &lt;author:%an&gt;  %s \"</span><br><span class="line"></span><br><span class="line">    st = status -uno -s</span><br><span class="line">    st2 = status -s</span><br><span class="line">    co = checkout</span><br><span class="line">    bl = blame --date=short</span><br><span class="line">    #gll = log --format=\"%Cgreen%h %Cred[%ad] %Creset&lt;%an&gt; %Creset %Cgreen%s %Creset \"</span><br><span class="line">    ci = commit</span><br><span class="line">    dt = difftool</span><br><span class="line">    dif = diff --word-diff</span><br><span class="line">        #di = diff --color-words</span><br><span class="line">    di = diff --no-ext-diff</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/22/Java_technology_stack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/22/Java_technology_stack/" itemprop="url">JAVA学习路线整理(持续更新)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-22T11:14:07+08:00">
                2019-12-22
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-12-25T14:43:48+08:00">
                2019-12-25
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  579 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  2 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学习路线"><a href="#学习路线" class="headerlink" title="学习路线"></a>学习路线</h1><p><img src="https://raw.githubusercontent.com/gewuang/cloudimg/master/data/JAVA%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF.png" alt="java学习路线"></p>
<h1 id="学习知识点"><a href="#学习知识点" class="headerlink" title="学习知识点"></a>学习知识点</h1><ul>
<li><input disabled type="checkbox"> 基础知识篇<ul>
<li><input disabled type="checkbox"> JAVA语言本身语法</li>
<li><input disabled type="checkbox"> 数据结构和算法</li>
<li><input disabled type="checkbox"> TCP/IP协议栈</li>
<li><input disabled type="checkbox"> 设计模式</li>
<li><input disabled type="checkbox"> 数据库和sql</li>
</ul>
</li>
<li><input disabled type="checkbox"> 项目工具篇<ul>
<li><input disabled type="checkbox"> linux操作系统</li>
<li><input disabled type="checkbox"> 代码工具<ul>
<li><input disabled type="checkbox"> Git</li>
</ul>
</li>
<li><input disabled type="checkbox"> 项目管理工具</li>
</ul>
</li>
<li><input disabled type="checkbox"> 应用框架篇<ul>
<li><input disabled type="checkbox"> Spring全家桶<ul>
<li><input disabled type="checkbox"> Spring</li>
<li><input disabled type="checkbox"> Spring Boot</li>
</ul>
</li>
<li><input disabled type="checkbox"> 中间件技术<ul>
<li><input disabled type="checkbox"> 消息队列<ul>
<li><input disabled type="checkbox"> kafka</li>
<li><input disabled type="checkbox"> RabbitMq</li>
</ul>
</li>
<li><input disabled type="checkbox"> RPC通信<ul>
<li><input disabled type="checkbox"> gRpc</li>
</ul>
</li>
<li><input disabled type="checkbox"> NoSQL<ul>
<li><input disabled type="checkbox"> mongoDb</li>
<li><input disabled type="checkbox"> redis</li>
</ul>
</li>
<li><input disabled type="checkbox"> NIO</li>
</ul>
</li>
<li><input disabled type="checkbox"> 分布式微服务</li>
<li><input disabled type="checkbox"> 虚拟化/容器化<ul>
<li><input disabled type="checkbox"> Docker</li>
<li><input disabled type="checkbox"> K8s</li>
</ul>
</li>
</ul>
</li>
<li><input disabled type="checkbox"> 源码<ul>
<li><input disabled type="checkbox"> JDK源码</li>
<li><input disabled type="checkbox"> JAVA并发编程</li>
<li><input disabled type="checkbox"> 应用框架设计思想和源码</li>
<li><input disabled type="checkbox"> 数据库深度优化<ul>
<li><input disabled type="checkbox"> MySQL调优</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="一、基础知识篇"><a href="#一、基础知识篇" class="headerlink" title="一、基础知识篇"></a>一、基础知识篇</h1><h2 id="JAVA基础语法"><a href="#JAVA基础语法" class="headerlink" title="JAVA基础语法"></a>JAVA基础语法</h2><ul>
<li>语法基础<br>  <a href="/2019/12/25/Java_basic/">java基础知识</a></li>
<li>编程思想：类、对象、封装、继承、多态、接口</li>
<li>容器</li>
<li>异常</li>
<li>泛型</li>
<li>I/O</li>
<li>注解</li>
<li>反射</li>
<li>图形化界面</li>
</ul>
<h2 id="数据结构与算法"><a href="#数据结构与算法" class="headerlink" title="数据结构与算法"></a>数据结构与算法</h2><blockquote>
<p>几大基础数据结构类型得烂熟于心，比如：<strong>字符串</strong>、<strong>链表</strong>、<strong>二叉树</strong>、<strong>栈</strong>、<strong>队列</strong>等等；基本的几大算法要了如指掌，比如<strong>查找</strong>、<strong>排序</strong>、<strong>动态规划</strong>等等。</p>
</blockquote>
<h2 id="TCP-IP协议栈"><a href="#TCP-IP协议栈" class="headerlink" title="TCP/IP协议栈"></a>TCP/IP协议栈</h2><ul>
<li>ARP协议</li>
<li>IP协议</li>
<li>ICMP协议</li>
<li>TCP协议</li>
<li>UDP协议</li>
<li>HTTP协议</li>
<li>HTTPS协议</li>
</ul>
<h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><ul>
<li><input disabled type="checkbox"> 创建型模式<ul>
<li><input disabled type="checkbox"> <strong>单例模式</strong></li>
<li><input disabled type="checkbox"> <strong>工厂模式</strong></li>
<li><input disabled type="checkbox"> 建造者模式</li>
<li><input disabled type="checkbox"> 原型模式</li>
</ul>
</li>
<li><input disabled type="checkbox"> 结构型模式<ul>
<li><input disabled type="checkbox"> 适配器模式</li>
<li><input disabled type="checkbox"> 桥接模式</li>
<li><input disabled type="checkbox"> 组合模式</li>
<li><input disabled type="checkbox"> 装饰模式</li>
<li><input disabled type="checkbox"> 外观模式</li>
<li><input disabled type="checkbox"> 享元模式</li>
<li><input disabled type="checkbox"> <strong>代理模式</strong></li>
</ul>
</li>
<li><input disabled type="checkbox"> 行为型模式<ul>
<li><input disabled type="checkbox"> 职责链模式</li>
<li><input disabled type="checkbox"> 命令模式</li>
<li><input disabled type="checkbox"> 迭代器模式</li>
<li><input disabled type="checkbox"> 中介者模式</li>
<li><input disabled type="checkbox"> 备忘录模式</li>
<li><input disabled type="checkbox"> 观察者模式</li>
<li><input disabled type="checkbox"> 状态模式</li>
<li><input disabled type="checkbox"> <strong>策略模式</strong></li>
<li><input disabled type="checkbox"> <strong>模板方法模式</strong></li>
<li><input disabled type="checkbox"> 访问者模式</li>
</ul>
</li>
</ul>
<h2 id="数据库和SQL"><a href="#数据库和SQL" class="headerlink" title="数据库和SQL"></a>数据库和SQL</h2><blockquote>
<p>数据库基本原理了解、sql语句熟练书写</p>
</blockquote>
<h1 id="二、项目工具"><a href="#二、项目工具" class="headerlink" title="二、项目工具"></a>二、项目工具</h1><h2 id="linux系统"><a href="#linux系统" class="headerlink" title="linux系统"></a>linux系统</h2><blockquote>
<p>基本命令使用、shell脚本，服务部署等</p>
</blockquote>
<h2 id="代码管理"><a href="#代码管理" class="headerlink" title="代码管理"></a>代码管理</h2><ul>
<li>Git</li>
</ul>
<h2 id="项目管理"><a href="#项目管理" class="headerlink" title="项目管理"></a>项目管理</h2><blockquote>
<p>maven或Grandle</p>
</blockquote>
<ul>
<li>Maven</li>
</ul>
<h1 id="三、应用框架"><a href="#三、应用框架" class="headerlink" title="三、应用框架"></a>三、应用框架</h1><h2 id="Spring全家桶"><a href="#Spring全家桶" class="headerlink" title="Spring全家桶"></a>Spring全家桶</h2><h3 id="Sping"><a href="#Sping" class="headerlink" title="Sping"></a>Sping</h3><blockquote>
<p>了解Spring、Mybatis等框架的基本原理 </p>
</blockquote>
<h3 id="Sping-Boot"><a href="#Sping-Boot" class="headerlink" title="Sping Boot"></a>Sping Boot</h3><blockquote>
<p>Spring Boot框架会熟练使用、开发业务、掌握基本原理 </p>
</blockquote>
<h3 id="SSM"><a href="#SSM" class="headerlink" title="SSM"></a>SSM</h3><blockquote>
<p>SSM组合框架会上手搭建项目、开发业务、掌握基本原理</p>
</blockquote>
<h2 id="中间件技术"><a href="#中间件技术" class="headerlink" title="中间件技术"></a>中间件技术</h2><h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><h4 id="1-Rabbit"><a href="#1-Rabbit" class="headerlink" title="1. Rabbit"></a>1. Rabbit</h4><h4 id="2-Kafka"><a href="#2-Kafka" class="headerlink" title="2. Kafka"></a>2. Kafka</h4><h3 id="RPC通信框架"><a href="#RPC通信框架" class="headerlink" title="RPC通信框架"></a>RPC通信框架</h3><h4 id="1-gRPC"><a href="#1-gRPC" class="headerlink" title="1. gRPC"></a>1. gRPC</h4><h4 id="2-Thrift"><a href="#2-Thrift" class="headerlink" title="2. Thrift"></a>2. Thrift</h4><h4 id="3-Dubbo"><a href="#3-Dubbo" class="headerlink" title="3. Dubbo"></a>3. Dubbo</h4><h3 id="NoSQL数据库"><a href="#NoSQL数据库" class="headerlink" title="NoSQL数据库"></a>NoSQL数据库</h3><h4 id="1-Redis"><a href="#1-Redis" class="headerlink" title="1. Redis"></a>1. Redis</h4><h4 id="2-memcached"><a href="#2-memcached" class="headerlink" title="2. memcached"></a>2. memcached</h4><h4 id="3-ElasticSearch"><a href="#3-ElasticSearch" class="headerlink" title="3. ElasticSearch"></a>3. ElasticSearch</h4><h3 id="NIO网络通信框架"><a href="#NIO网络通信框架" class="headerlink" title="NIO网络通信框架"></a>NIO网络通信框架</h3><h4 id="1-Netty"><a href="#1-Netty" class="headerlink" title="1. Netty"></a>1. Netty</h4><h3 id="分布式微服务"><a href="#分布式微服务" class="headerlink" title="分布式微服务"></a>分布式微服务</h3><h4 id="1-Spring-Cloud"><a href="#1-Spring-Cloud" class="headerlink" title="1. Spring Cloud"></a>1. Spring Cloud</h4><h3 id="虚拟化-容器化"><a href="#虚拟化-容器化" class="headerlink" title="虚拟化/容器化"></a>虚拟化/容器化</h3><h4 id="1-Docker"><a href="#1-Docker" class="headerlink" title="1. Docker"></a>1. Docker</h4><h4 id="2-K8s"><a href="#2-K8s" class="headerlink" title="2. K8s"></a>2. K8s</h4><h1 id="四、源码"><a href="#四、源码" class="headerlink" title="四、源码"></a>四、源码</h1><ul>
<li>JDK源码分析</li>
<li>Java并发编程</li>
<li>JVM原理及调优</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/21/inode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/21/inode/" itemprop="url">linux文件系统-inode学习整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-21T10:36:21+08:00">
                2019-12-21
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-12-26T10:06:23+08:00">
                2019-12-26
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.6k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="linux文件系统-inode学习整理"><a href="#linux文件系统-inode学习整理" class="headerlink" title="linux文件系统-inode学习整理"></a>linux文件系统-inode学习整理</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>linux文件系统可讲的模块有很多，包括文件系统整体架构、文件系统分类、虚拟文件系统以及文件系统存储结构等等，本文主要介绍的是文件系统的存储结构，也就是本文的重点-inode。</p>
<h2 id="文件存储结构"><a href="#文件存储结构" class="headerlink" title="文件存储结构"></a>文件存储结构</h2><p>首先从开天辟地开始介绍，我们知道数据是保存在磁盘中的，磁盘具体存贮原理细节不在这里进行说明，而磁盘中的存储空间是如何进行管理的？这里就说到了磁盘块的划分：</p>
<ol>
<li><strong>超级快：</strong>文件系统中第一个块，存放的是文件系统本身的结构信息，包括每个区域的大小以及未被使用的磁盘块等等信息</li>
<li><strong>inode节点表：</strong>超级块的下部分就是inode节点表了，也就是我们上面的inode table。每个inode节点对应一个文件（或目录）的结构，包括了文件的创建时间、权限等信息，下面有详细的介绍。</li>
<li><strong>数据区：</strong>显然它就是用来保存文件内容的区域，这里要介绍下，磁盘上的块大小一样，一般来说为4kb，即连续的八个扇区（512字节），块手是文件存取的最小单位，超过块大小的文件会放到下一个块中。</li>
</ol>
<p>就像大家知道的，linux一切皆是文件，所以目录项也是文件，不过这个文件中存储的是目录下的文件及子目录组织结构，相应的文件指向了inode的节点，这里需要说明每个文件对应一个inode节点，之后通过inode节点中有关数据区块的信息找到对应的数据。</p>
<p>文件存储结构的整体架构，如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/gewuang/cloudimg/master/data/20191215165841.png" alt="文件存储架构"></p>
<h3 id="inode节点"><a href="#inode节点" class="headerlink" title="inode节点"></a>inode节点</h3><blockquote>
<p>inode节点详解</p>
</blockquote>
<p>inode节点就是文件元数据的存储区，包括了文件如下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- 文件的字节数</span><br><span class="line">- 文件拥有者的User ID</span><br><span class="line">- 文件的Group ID</span><br><span class="line">- 文件的读、写、执行权限</span><br><span class="line">- 文件的时间戳，共有三个：ctime指inode上一次变动的时间，</span><br><span class="line">       mtime指文件内容上一次变动的时间，atime指文件上一次打开的时间。</span><br><span class="line">- 链接数，即有多少文件名指向这个inode</span><br><span class="line">- 文件数据block的位置</span><br></pre></td></tr></table></figure>

<p>可以使用<code>stat filename</code> 命令查看：</p>
<p><img src="https://raw.githubusercontent.com/gewuang/cloudimg/master/data/20191215214312.png" alt="inode节点信息"></p>
<p>基本除了文件内容外的信息都存储在inode节点中。</p>
<p>inode节点的大小一般来说为128或者256个字节，inode节点的总数，在格式化时就给定，一般是每1KB或每2KB就设置一个inode。假定在一块1GB的硬盘中，每个inode节点的大小为128字节，每1KB就设置一个inode，那么inode table的大小就会达到128MB，占整块硬盘的12.8%。</p>
<p>如果想要查看inode大小，可以使用<code>dump2fs -h /dev/sda1 | grep &quot;Inode size&quot;</code>查看:</p>
<p><img src="https://raw.githubusercontent.com/gewuang/cloudimg/master/data/20191215215212.png" alt="inode大小"></p>
<p>如果要查看每个磁盘的inode使用情况，可以使用<code>df -i</code>命令查看：</p>
<p><img src="https://raw.githubusercontent.com/gewuang/cloudimg/master/data/20191215215108.png" alt="inode使用情况"></p>
<p>每个文件都有自己的对应的inode号，这里要说明的是unix/linux系统中主要根据inode号来识别文件，文件名只是我们用来整理和分辨文件的别称，而文件名主要存储在目录项中。</p>
<h3 id="目录项"><a href="#目录项" class="headerlink" title="目录项"></a>目录项</h3><blockquote>
<p> 目录项的结构</p>
</blockquote>
<p>目录项是linux文件系统的重要组成部分，在linux中目录项也是一种文件，不过他内部存储的信息由两部分组成</p>
<ul>
<li>文件名</li>
<li>inode编号</li>
</ul>
<p>我们可以通过<code>ls -ai dirname</code> 查看目录结构：<br><img src="https://raw.githubusercontent.com/gewuang/cloudimg/master/data/20191215220517.png" alt></p>
<p>当我们创建目录时，一定会有的两个内容就是<code>.</code>和<code>..</code>，<code>.</code>表示的是当前目录文件所对应的inode号，<code>..</code>对应的是当前目录父目录的inode号，其他的就是我们目录下的文件和对应的inode号。</p>
<p>介绍完上面这些信息我们再来看一开始的流程就很清楚了：</p>
<blockquote>
<p>首先从目录文件中拿到我们所需文件对应的inode号，通过inode号拿到文件的元数据，通过其中所指向的数据块号取出文件内容。</p>
</blockquote>
<h2 id="创建流程"><a href="#创建流程" class="headerlink" title="创建流程"></a>创建流程</h2><blockquote>
<p>通过创建流程串通知识点</p>
</blockquote>
<h3 id="文件创建流程"><a href="#文件创建流程" class="headerlink" title="文件创建流程"></a>文件创建流程</h3><p>通过前面的内容我们了解到了文件取出的流程，那创建一个文件的流程是什么样的呢？下面我们来介绍下创建文件的流程。</p>
<ol>
<li><strong>存储inode节点信息：</strong>内核首先找到一块空的inode节点，将文件的信息存在节点中。</li>
<li><strong>存储数据信息：</strong>数据信息即文件信息，内核从未使用的块列表中找到几个数据块（一般是不连续的），如300、230、540等，内核将缓存区中的数据存储到对应的数据块中。</li>
<li><strong>记录分配情况：</strong>存储完信息后，数据块的分配情况记录在inode节点信息中</li>
<li><strong>添加文件名到目录：</strong>最后内核将文件名和对应的inode节点放到目录文件中。</li>
</ol>
<h2 id="inode应用扩展"><a href="#inode应用扩展" class="headerlink" title="inode应用扩展"></a>inode应用扩展</h2><h3 id="硬连接"><a href="#硬连接" class="headerlink" title="硬连接"></a>硬连接</h3><p>一般情况下，linux中的文件名和inode号码是一一对应的，不过也可以多个文件名指向同一个inode节点，也就是我们要介绍的<strong>硬链接</strong>。</p>
<p>创建硬链接的命令为<code>ln 源文件目标文件</code>，硬链接与正常的文件相同，只是与其他文件共享同一个inode节点，前面介绍的inode节点信息中Links数就是文件名指向的数量，当对其进行删除的时候只会对inode节点中的links数减少1，当为0的时候文件才会真正被删除。</p>
<p><img src="https://raw.githubusercontent.com/gewuang/cloudimg/master/data/20191215224505.png" alt="硬链接"></p>
<p>这里说明下，目录项中的<code>.</code>和<code>..</code>也是一种硬链接。</p>
<h3 id="软链接"><a href="#软链接" class="headerlink" title="软链接"></a>软链接</h3><p>介绍完硬链接，再介绍一种我们平常使用比较多的一种方式：软链接。</p>
<p><code>ln -s 源文件 目标文件</code>是软链接的创建方式，虽然看起来只是多了个选项s，当时内部原理完全不同。</p>
<p>软链接是单独生成一个链接文件，有自己的inode号，是一个单独的文件，这个文件中的信息是链接的文件的信息。</p>
<p><img src="https://raw.githubusercontent.com/gewuang/cloudimg/master/data/20191215224252.png" alt="软链接文件"></p>
<p>如上图，可以把软链接看做是一个指针，只不过指针里面的内容为所指向文件的路径，这个指针有自己单独的内存空间。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://mp.weixin.qq.com/s?__biz=MzI3NzA5MzUxNA==&mid=2664607114&idx=1&sn=a017c12e763285d14a962ac6b73777dc&chksm=f04d806fc73a09792064565050f68c15c996bfe70ffecbc76fa4f3e48b56a64b3c1c5a8c11f8&mpshare=1&scene=1&srcid=1211DeDoAOtew0UTU3RNhmd4&sharer_sharetime=1576391020479&sharer_shareid=9611729a86ebeb77b8f7858bd1081cff&key=f80acc1ad3183d1e3488fe809bb273e8289beb41eb453824dcfdf6728b500953fcdc2259032892602763732453d32b3cffb598877341e596dc68d6be96522be7cdcbf5620c97edd5ad378e82259cb5f5&ascene=1&uin=NzM3NTc5MTA0&devicetype=Windows+10&version=62070158&lang=zh_CN&exportkey=AauivB%2B7nT2Kzb17AknytBY%3D&pass_ticket=9C2xO5q7uhHGU40DmWaCTcrigOu1V08lxi5UkDVlKNHyveToj50yVLcuABmJLZBm" target="_blank" rel="noopener">理解inode</a></p>
<p><a href="https://blog.csdn.net/yuexiaxiaoxi27172319/article/details/45241923" target="_blank" rel="noopener">Linux文件系统详解</a></p>

          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/25/libuv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/25/libuv/" itemprop="url">libuv介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-25T18:49:10+08:00">
                2019-08-25
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-01-20T16:59:30+08:00">
                2020-01-20
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Node-js/" itemprop="url" rel="index">
                    <span itemprop="name">Node.js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  64 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h1><p>先来看<a href="https://libuv.org/" target="_blank" rel="noopener">官网</a>对他的介绍：</p>
<blockquote>
<p>libuv is a multi-platform support library with a focus on asynchronous I/O.</p>
</blockquote>
<p>直译过来就是：<strong>libuv是一个关注于异步IO的多平台库</strong></p>
<h1 id="为什么用它"><a href="#为什么用它" class="headerlink" title="为什么用它"></a>为什么用它</h1><h1 id="底层原理"><a href="#底层原理" class="headerlink" title="底层原理"></a>底层原理</h1><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="http://docs.libuv.org/en/v1.x/design.html" target="_blank" rel="noopener">libuv design</a></p>
<p><a href="https://zh.wikipedia.org/wiki/Libuv" target="_blank" rel="noopener">wiki/libuv</a></p>

          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/25/palindrome/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ramon">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ramon's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/25/palindrome/" itemprop="url">最长回文子序列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-25T18:46:19+08:00">
                2019-08-25
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-08-25T18:46:19+08:00">
                2019-08-25
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/leetcode/" itemprop="url" rel="index">
                    <span itemprop="name">leetcode</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  595 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>给定一个字符串 s，找到 s 中最长的回文子串。你可以假设 s 的最大长度为 1000。</p>
<p>示例1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入: &quot;babad&quot;</span><br><span class="line">输出: &quot;bab&quot;</span><br><span class="line">注意: &quot;aba&quot; 也是一个有效答案。</span><br></pre></td></tr></table></figure>

<p>示例2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">输入: &quot;cbbd&quot;</span><br><span class="line">输出: &quot;bb&quot;</span><br></pre></td></tr></table></figure>

<h3 id="anwser"><a href="#anwser" class="headerlink" title="anwser"></a>anwser</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isPalindromic</span><span class="params">(<span class="built_in">string</span> sub)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">bool</span> ret = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">stack</span>&lt;<span class="keyword">char</span>&gt; c;</span><br><span class="line">        <span class="keyword">int</span> len = sub.length();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">char</span> a;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (; i&lt;len; i++) &#123;</span><br><span class="line">            c.push(sub[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">            a = c.top();</span><br><span class="line">            c.pop();</span><br><span class="line">            <span class="keyword">if</span>(sub[i] != a) &#123;</span><br><span class="line">                ret = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">longestPalindrome</span><span class="params">(<span class="built_in">string</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">string</span> ret = s.substr(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> len = s.length();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(; i&lt;len<span class="number">-1</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (j=len<span class="number">-1</span>; j&gt;<span class="number">0</span>; j--) &#123;</span><br><span class="line">                <span class="keyword">if</span>(isPalindromic(s.substr(i, j-i+<span class="number">1</span>))) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(max &lt; (j-i)) &#123;</span><br><span class="line">                        ret = s.substr(i, j-i+<span class="number">1</span>);</span><br><span class="line">                        max = j-i;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(max!=<span class="number">0</span> &amp;&amp; max&gt;(j-i)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(max!=<span class="number">0</span> &amp;&amp; max&gt;(len<span class="number">-1</span>-i)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>谨记大神的说法，想不出高级解法就先用暴力法，上面就是暴力法，不过超时了？题目没有说时间啊、、、不懂了，但是毕竟也是自己写的，所以还是贴出来吧，优秀解法如下：<br>动态规划法（Time:O(n^2)）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">longestPalindrome</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = s.length();</span><br><span class="line">        <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[n][n];</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>, maxLen = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n;i++)&#123;</span><br><span class="line">            dp[i][i] = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span>(maxLen &lt; <span class="number">1</span>) &#123; start = i; maxLen = <span class="number">1</span>;&#125;</span><br><span class="line">            <span class="keyword">if</span>(i&lt;n-<span class="number">1</span> &amp;&amp; s.charAt(i) == s.charAt(i+<span class="number">1</span>)) &#123;</span><br><span class="line">                dp[i][i+<span class="number">1</span>] = <span class="keyword">true</span>;</span><br><span class="line">                start = i;</span><br><span class="line">                maxLen = <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> numChars=<span class="number">3</span>; numChars&lt;=n;numChars++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;n-numChars+<span class="number">1</span>; j++)&#123;</span><br><span class="line">                <span class="keyword">int</span> pos = j+numChars-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span>(dp[j+<span class="number">1</span>][pos-<span class="number">1</span>] &amp;&amp; s.charAt(j) == s.charAt(pos)) &#123;</span><br><span class="line">                    dp[j][pos] = <span class="keyword">true</span>;</span><br><span class="line">                    start = j;</span><br><span class="line">                    maxLen = numChars;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s.substring(start, start+maxLen);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Best solution:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LongestPalindromeNode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String longestPalindrome;</span><br><span class="line">        <span class="keyword">int</span> length;</span><br><span class="line"></span><br><span class="line">        LongestPalindromeNode() &#123;</span><br><span class="line">            <span class="keyword">this</span>.longestPalindrome = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">this</span>.length = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> LongestPalindromeNode <span class="title">helper</span><span class="params">(String word, <span class="keyword">int</span> left, <span class="keyword">int</span> right, LongestPalindromeNode longestPalindromeNode)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> curr_max_length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(left &gt;= <span class="number">0</span> &amp;&amp; right &lt; word.length() &amp;&amp; word.charAt(left) == word.charAt(right)) &#123;</span><br><span class="line">            left--;</span><br><span class="line">            right++;</span><br><span class="line">        &#125;</span><br><span class="line">        curr_max_length = right - left -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(longestPalindromeNode.length &lt; curr_max_length) &#123;</span><br><span class="line">            longestPalindromeNode.length = curr_max_length;</span><br><span class="line">            longestPalindromeNode.longestPalindrome = word.substring(left+<span class="number">1</span>, right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> longestPalindromeNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">longestPalindrome</span><span class="params">(String word)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> length = word.length();</span><br><span class="line">        <span class="keyword">if</span>(length == <span class="number">0</span> || length == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> word;</span><br><span class="line"></span><br><span class="line">        LongestPalindromeNode longestPalindromeNode = <span class="keyword">new</span> LongestPalindromeNode();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; word.length(); idx++) &#123;</span><br><span class="line">            <span class="keyword">int</span> remaining_length = length - idx;</span><br><span class="line">            <span class="keyword">int</span> max_palindrome_length_can_be_formed = (remaining_length) + (remaining_length-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(max_palindrome_length_can_be_formed &lt; longestPalindromeNode.length)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            longestPalindromeNode = helper(word, idx, idx, longestPalindromeNode);</span><br><span class="line">            longestPalindromeNode = helper(word, idx, idx+<span class="number">1</span>, longestPalindromeNode);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> longestPalindromeNode.longestPalindrome;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    
    <div>
        
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ramon</p>
              <p class="site-description motion-element" itemprop="description">当你觉得晚的时候，恰恰是最早的时候</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ramon</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  








  












  





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
